<!DOCTYPE html>
<html lang="ja" class="hltr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, user-scalable=0, maximum-scale=1">
    <title>Máy nhận dạng ký tự - DoHoaiNam Pages</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="js/js.cookie-1.5.1.js"></script>
    <script src="https://unpkg.com/tesseract.js/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="css/styles/dohoainam-ebpaj-style.css">
    <style>
      #page_segmentation_select,
      #language_select {
        width: 90px;
      }

      section.p-image {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -webkit-user-drag: none;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <form>
      <div class="notranslate" style="bottom: 8px; left: 8px; position: fixed;">
        <select id="background_select">
          <option value="white">Trắng</option>
          <option value="black">Đen</option>
          <option value="sepia">Sepia</option>
          <option value="cream">Kem</option>
        </select>
      </div>
    </form>
    <form>
      <div class="notranslate" style="margin-bottom: 8px; text-align: initial; top: 8px;">
        <label for="image_file">Chọn tệp hình ảnh</label>
        <input id="image_file" type="file" accept="image/*">
      </div>
      <div style="text-align: center;">
        <input id="url" type="text" onclick="this.value = ''" value="Địa chỉ liên kết">
      </div>
      <div class="notranslate" style="bottom: 8px; position: fixed; right: 8px;">
        <select id="language_select">
          <option value="chi_sim">Tiếng Trung</option>
          <option value="chi_sim_vert">Tiếng Trung (Dọc)</option>
          <option value="chi_tra">Tiếng Trung (Phổn thể)</option>
          <option value="chi_tra_vert">Tiếng Trung (Phổn thể) (Dọc)</option>
          <option value="eng">Tiếng Anh</option>
          <option value="jpn">Tiếng Nhật</option>
          <option value="jpn_vert">Tiếng Nhật (Dọc)</option>
          <option value="vie">Tiếng Việt</option>
        </select>
        <select id="page_segmentation_select">
          <option value="2">AUTO_ONLY</option>
          <option value="3">AUTO</option>
          <option value="4">SINGLE_COLUMN</option>
          <option value="5">SINGLE_BLOCK_VERT_TEXT</option>
          <option value="6" selected>SINGLE_BLOCK</option>
          <option value="7">SINGLE_LINE</option>
          <option value="8">SINGLE_WORD</option>
          <option value="9">CIRCLE_WORD</option>
          <option value="10">SINGLE_CHAR</option>
          <option value="11">SPARSE_TEXT</option>
          <option value="13">RAW_LINE</option>
        </select>
        <input id="ocr_button" type="button" value="Nhận dạng ký tự">
      </div>
    </form>
    <section class="p-image">
      <div class="main" style="padding: 0 40px;">
        <div id="crop" style="border: thin dashed red; position: absolute;"></div>
        <img id="preview">
      </div>
    </section>
    <section class="p-text">
      <ol class="main"></ol>
    </section>
    <script>
      const { createWorker, PSM, OEM } = Tesseract;
      const worker = createWorker({
        langPath: 'https://raw.githubusercontent.com/tesseract-ocr/tessdata_best/main',
        gzip: false,
        errorHandler: function () {
          $("#page_segmentation_select").prop("disabled", false);
          $("#language_select").prop("disabled", false);
          $("#image_file").prop("disabled", false);
          $("#ocr_button").prop("disabled", false);
          $("#ocr_button").val("Nhận dạng ký tự");
        }
      });

      var recognizeImage;

      var cropLeft;
      var cropTop;
      var cropRight;
      var cropBottom;

      var isCroping;

      $(document).ready(function () {
        $("#background_select").val($.cookie('background') || "white").change();
        $("ol.main").hide();
        $("#crop").hide();
      });

      $("#background_select").on("change", function () {
        if (this.value !== 'white') {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != undefined ?
            document.documentElement.getAttribute('style').replace(/ black;/g, '')
              .replace(/black;/g, '')
              .replace(/ sepia;/g, '')
              .replace(/sepia;/g, '')
              .replace(/ cream;/g, '')
              .replace(/cream;/g, '')
              .concat(' ' + this.value.concat(';')) :
            this.value.concat(';'));
          Cookies.set('background', this.value, { expires: 365 });
        } else if ($(document.documentElement).attr("style") != undefined) {
          $(document.documentElement).attr("style", document.documentElement.getAttribute('style').replace(/ black;/g, '')
            .replace(/black;/g, '')
            .replace(/ sepia;/g, '')
            .replace(/sepia;/g, '')
            .replace(/ cream;/g, '')
            .replace(/cream;/g, ''));
          Cookies.remove('background');
        } else {
          $(document.documentElement).removeAttr("style");
        }
      });

      $("#image_file").on("input", function () {
        $("#url").val("Địa chỉ liên kết");
        $("#preview").removeAttr("src");
        $("#crop").hide();

        if (this.files.length > 0) {
          let reader = new FileReader();

          reader.onload = function () {
            $("#preview").attr("src", this.result);
            recognizeImage = $("#preview").attr("src");
          };

          reader.readAsDataURL(this.files[0]);

          if ($("#ocr_button").val() === 'Xong') {
            $("ol.main").removeAttr("contentEditable");
            $("ol.main").hide();
            $("#ocr_button").val("Nhận dạng ký tự");
          }
        }
      });

      $("#url").on("input", function () {
        $("#image_file").val(null);
        $("#preview").removeAttr("src");
        $("#crop").hide();

        if (this.value !== 'Địa chỉ liên kết' && $("#url").val().length > 0) {
          $("#preview").attr("src", this.value);
          recognizeImage = $("#preview").attr("src");
        }

        if ($("#ocr_button").val() === 'Xong') {
          $("ol.main").removeAttr("contentEditable");
          $("ol.main").hide();
          $("#ocr_button").val("Nhận dạng ký tự");
        }
      });

      $("#language_select").on("change", function () {
        if ($("#ocr_button").val() === 'Xong') {
          recognize($("#language_select").val(), $("#page_segmentation_select").val(), recognizeImage);
        }
      });

      $("#page_segmentation_select").on("change", function () {
        if ($("#ocr_button").val() === 'Xong') {
          recognize($("#language_select").val(), $("#page_segmentation_select").val(), recognizeImage);
        }
      });

      $("#ocr_button").click(function () {
        if ($("#image_file").prop("files").length > 0 || ($("#url").val() !== 'Địa chỉ liên kết' && $("#url").val().length > 0)) {
          if (this.value === 'Nhận dạng ký tự') {
            recognize($("#language_select").val(), $("#page_segmentation_select").val(), recognizeImage);

            $("ol.main").show();
          } else {
            $("ol.main").removeAttr("contentEditable");
            $("ol.main").hide();
            this.value = 'Nhận dạng ký tự';
          }
        }
      });

      $("#preview").on("mousedown", function(event) {
        if (isHoverOnPreview(event) && $("#ocr_button").val() === 'Nhận dạng ký tự') {
          cropImage('start', event);
        }
      });

      $("#preview").on("touchstart", function(event) {
        if (isHoverOnPreview(event) && $("#ocr_button").val() === 'Nhận dạng ký tự') {
          cropImage('start', event);
        }
      });

      $("#preview").on("mousemove", function(event) {
        if (isHoverOnPreview(event)) {
          cropImage('move', event);
        }
      });

      $("#preview").on("touchmove", function(event) {
        if (isHoverOnPreview(event)) {
          cropImage('move', event);
        }
      });

      $("#preview").on("mouseup", function(event) {
        cropImage('end', event);
      });

      $("#preview").on("touchend", function(event) {
        cropImage('end', event);
      });

      $("ol.main").on("input", function () {
        $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * $("ol.main").html().split('\n').length.toString().concat('.').length + "px");
      });

      async function recognize(lang, pageseg_mode, input) {
        $("#ocr_button").prop("disabled", true);
        $("#image_file").prop("disabled", true);
        $("#language_select").prop("disabled", true);
        $("#page_segmentation_select").prop("disabled", true);
        $("ol.main").html(null);

        await worker.load();
        await worker.loadLanguage(lang);
        await worker.initialize(lang);
        await worker.setParameters({
          tessedit_pageseg_mode: pageseg_mode,
          tessedit_ocr_engine_mode: OEM.LSTM_ONLY
        });

        const { data: { text } } = await worker.recognize(input);
        $("#page_segmentation_select").prop("disabled", false);
        $("#language_select").prop("disabled", false);
        $("#image_file").prop("disabled", false);
        $("#ocr_button").prop("disabled", false);
        $("#ocr_button").val("Xong");

        var sentences = text.split('\n');

        for (let i = 0; i < sentences.length; i++) {
          $("ol.main").append('<li><div class="main">' + (sentences[i] !== '' ? (lang === 'eng' || lang === 'vie' ? sentences[i] : sentences[i].replace(/\s/g, '')) : '<br>') + '</div></li>' + (i + 1 < sentences.length ? '\n' : ''));
        }

        $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * $("ol.main").html().split('\n').length.toString().concat('.').length + "px");
        $("section.p-text div.main").css("display", "inline-block");
        $("ol.main").attr("contentEditable", "true");
      }

      function isHoverOnPreview(mouseEvent) {
        return mouseEvent.pageX >= $("#preview").offset().left && mouseEvent.pageY >= $("#preview").offset().top && mouseEvent.pageX <= $("#preview").offset().left + $("#preview").width() && mouseEvent.pageY <= $("#preview").offset().top + $("#preview").height();
      }

      function cropImage(place, event) {
        let imageOffsetLeft = $("#preview").offset().left;
        let imageOffsetTop = $("#preview").offset().top;

        switch (place) {
          case 'start':
            $(document.body).css("overflow", "hidden");
            isCroping = true;
            cropLeft = event.pageX - imageOffsetLeft;
            cropTop = event.pageY - imageOffsetTop;
            break;
          case 'move':
            if (isCroping) {
              cropRight = event.pageX - imageOffsetLeft;
              cropBottom = event.pageY - imageOffsetTop;

              let cropX = cropRight > cropLeft ? cropLeft : cropRight;
              let cropY = cropBottom > cropTop ? cropTop : cropBottom;
              let cropWidth = cropRight > cropLeft ? cropRight - cropLeft : cropLeft - cropRight;
              let cropHeight = cropBottom > cropTop ? cropBottom - cropTop : cropTop - cropBottom;

              $("#crop").css({
                left: (cropX + imageOffsetLeft) + 'px',
                top: (cropY + imageOffsetTop) + 'px',
                height: (cropHeight - parseInt($("#crop").css("border-width")) * 2) + 'px',
                width: (cropWidth - parseInt($("#crop").css("border-width")) * 2) + 'px'
              });

              $("#crop").show();
            }

            break;
          case 'end':
            if ($("#ocr_button").val() !== 'Nhận dạng ký tự' || !isCroping || (cropRight > cropLeft ? cropRight - cropLeft : cropLeft - cropRight) < 12 || (cropBottom > cropTop ? cropBottom - cropTop : cropTop - cropBottom) < 12) {
              $("#crop").hide();
              cropLeft = $("#preview").offset().left;
              cropTop = $("#preview").offset().top;
              cropRight = $("#preview").offset().right;
              cropBottom = $("#preview").offset().bottom;
              $(document.body).removeAttr("style");
              recognizeImage = $("#preview").attr("src");
              break;
            }

            if (isCroping) {
              let cropX = cropRight > cropLeft ? cropLeft : cropRight;
              let cropY = cropBottom > cropTop ? cropTop : cropBottom;
              let cropWidth = cropRight > cropLeft ? cropRight - cropLeft : cropLeft - cropRight;
              let cropHeight = cropBottom > cropTop ? cropBottom - cropTop : cropTop - cropBottom;

              let img = new Image();

              img.crossOrigin = 'Anonymous';
              img.onload = function () {
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');

                let xOffset = this.width / $("#preview").width();
                let yOffset = this.height / $("#preview").height();

                ctx.drawImage(this, cropX * xOffset, cropY * yOffset, cropWidth * xOffset, cropHeight * yOffset, 0, 0, cropWidth * xOffset, cropHeight * yOffset);

                recognizeImage = canvas.toDataURL();
              };

              img.src = $("#preview").attr("src");
              isCroping = false;
              $(document.body).removeAttr("style");
            }

            break;
        }
      }
    </script>
  </body>
</html>