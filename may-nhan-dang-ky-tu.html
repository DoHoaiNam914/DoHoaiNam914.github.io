<!DOCTYPE html>
<html lang="ja" class="hltr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, user-scalable=0, maximum-scale=1">
    <title>Máy nhận dạng ký tự - DoHoaiNam Pages</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="js/js.cookie-1.5.1.js"></script>
    <script src="https://unpkg.com/tesseract.js@3.0.3/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="css/styles/dohoainam-ebpaj-style.css">
    <style>
      #page_segmentation_select,
      #language_select {
        width: 90px;
      }
    </style>
  </head>
  <body>
    <form>
      <div class="notranslate" style="bottom: 8px; left: 8px; position: fixed;">
        <select id="background_select">
          <option value="white">Trắng</option>
          <option value="black">Đen</option>
          <option value="sepia">Sepia</option>
          <option value="cream">Kem</option>
        </select>
      </div>
    </form>
    <form>
      <div class="notranslate" style="margin-bottom: 8px; text-align: initial; top: 8px;">
        <label for="image_file">Chọn tệp hình ảnh</label>
        <input id="image_file" type="file" accept="image/*">
      </div>
      <div style="text-align: center;">
        <input id="url" type="text" onclick="this.select()" value="Địa chỉ liên kết">
      </div>
      <div class="notranslate" style="bottom: 8px; position: fixed; right: 8px;">
        <select id="language_select">
          <option value="chi_sim">Tiếng Trung</option>
          <option value="chi_sim_vert">Tiếng Trung (Dọc)</option>
          <option value="chi_tra">Tiếng Trung (Phổn thể)</option>
          <option value="chi_tra_vert">Tiếng Trung (Phổn thể) (Dọc)</option>
          <option value="eng">Tiếng Anh</option>
          <option value="jpn">Tiếng Nhật</option>
          <option value="jpn_vert">Tiếng Nhật (Dọc)</option>
          <option value="vie">Tiếng Việt</option>
        </select>
        <select id="page_segmentation_select">
          <option value="2">AUTO_ONLY</option>
          <option value="3">AUTO</option>
          <option value="4">SINGLE_COLUMN</option>
          <option value="5">SINGLE_BLOCK_VERT_TEXT</option>
          <option value="6" selected>SINGLE_BLOCK</option>
          <option value="7">SINGLE_LINE</option>
          <option value="8">SINGLE_WORD</option>
          <option value="9">CIRCLE_WORD</option>
          <option value="10">SINGLE_CHAR</option>
          <option value="11">SPARSE_TEXT</option>
          <option value="13">RAW_LINE</option>
        </select>
        <input id="ocr_button" type="button" value="Nhận dạng ký tự">
      </div>
    </form>
    <section class="p-image">
      <div class="main"></div>
    </section>
    <section class="p-text">
      <ol class="main"></ol>
    </section>
    <script>
      const { createWorker, PSM, OEM } = Tesseract;
      const worker = createWorker({
        langPath: 'https://raw.githubusercontent.com/tesseract-ocr/tessdata_best/main'
        errorHandler: function () {
          $("#page_segmentation_select").prop("disabled", false);
          $("#language_select").prop("disabled", false);
          $("#image_file").prop("disabled", false);
          $("#ocr_button").prop("disabled", false);
          $("#ocr_button").val("Nhận dạng ký tự");
        }
      });

      const imageReader = new FileReader();

      $("#background_select").on("change", function () {
        if (this.value !== 'white') {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != undefined ?
            document.documentElement.getAttribute('style').replace(/ black;/g, '')
              .replace(/black;/g, '')
              .replace(/ sepia;/g, '')
              .replace(/sepia;/g, '')
              .replace(/ cream;/g, '')
              .replace(/cream;/g, '')
              .concat(' ' + this.value.concat(';')) :
            this.value.concat(';'));
          Cookies.set('background', this.value, { expires: 365 });
        } else if ($(document.documentElement).attr("style") != undefined) {
          $(document.documentElement).attr("style", document.documentElement.getAttribute('style').replace(/ black;/g, '')
            .replace(/black;/g, '')
            .replace(/ sepia;/g, '')
            .replace(/sepia;/g, '')
            .replace(/ cream;/g, '')
            .replace(/cream;/g, ''));
          Cookies.remove('background');
        } else {
          $(document.documentElement).removeAttr("style");
        }
      });

      $(document).ready(function () {
        $("#background_select").val($.cookie('background') || "white").change();
        $("ol.main").hide();
      });

      $("#image_file").on("input", function () {
        $("#url").val("Địa chỉ liên kết");
        $("img").remove();

        imageReader.readAsDataURL(this.files[0]);

        if ($("#ocr_button").val() === 'Xong') {
          if ($("#image_file").prop("files").length > 0) {
            recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#image_file").prop("files")[0]);
          } else {
            recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#url").val());
          }
        }
      });

      $("#language_select").on("change", function () {
        if ($("#ocr_button").val() === 'Xong') {
          if ($("#image_file").prop("files").length > 0) {
            recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#image_file").prop("files")[0]);
          } else {
            recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#url").val());
          }
        }
      });

      $("#page_segmentation_select").on("change", function () {
        if ($("#ocr_button").val() === 'Xong') {
          if ($("#image_file").prop("files").length > 0) {
            recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#image_file").prop("files")[0]);
          } else {
            recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#url").val());
          }
        }
      });

      $("#ocr_button").click(function () {
        if ($("#image_file").prop("files").length > 0 || ($("#url").val() !== 'Địa chỉ liên kết' && $("#url").val().length > 0)) {
          if (this.value === 'Nhận dạng ký tự') {
            $("#url").hide();

            if ($("#image_file").prop("files").length > 0) {
              recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#image_file").prop("files")[0]);
            } else {
              recognize($("#language_select").val(), $("#page_segmentation_select").val(), $("#url").val());
            }

            $("ol.main").show();
          } else {
            $("img").remove();
            $("ol.main").removeAttr("contentEditable");
            $("ol.main").hide();
            $("#url").show();
            this.value = 'Nhận dạng ký tự';
          }
        }
      });

      $("ol.main").on("input", function () {
        $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * document.querySelector('ol.main').innerHTML.split('\n').length.toString().concat('.').length + "px");
      });

      $("#url").on("input", function () {
        $("#image_file").val(null);
        $("img").remove();

        if ($("#ocr_button").val() === 'Xong') {
          $("#ocr_button").val("Nhận dạng ký tự");
        }
      });

      async function recognize(lang, pageseg_mode, input) {
        $("img").remove();

        if ($("#image_file").prop("files").length > 0) {
          $("div.main").append("<img src=\"" + imageReader.result + "\">");
        } else {
          $("div.main").append("<img src=\"" + $("#url").val() + "\">");
        }

        $("#ocr_button").prop("disabled", true);
        $("#image_file").prop("disabled", true);
        $("#language_select").prop("disabled", true);
        $("#page_segmentation_select").prop("disabled", true);
        $("ol.main").html(null);

        await worker.load();
        await worker.loadLanguage(lang);
        await worker.initialize(lang);
        await worker.setParameters({
          tessedit_pageseg_mode: pageseg_mode,
          tessedit_ocr_engine_mode: OEM.LSTM_ONLY
        });

        const { data: { text } } = await worker.recognize(input);
        $("#page_segmentation_select").prop("disabled", false);
        $("#language_select").prop("disabled", false);
        $("#image_file").prop("disabled", false);
        $("#ocr_button").prop("disabled", false);

        var sentences = text.split('\n');

        for (let i = 0; i < sentences.length; i++) {
          $("ol.main").append('<li><div class="main">' + (sentences[i] !== '' ? (lang === 'eng' || lang === 'vie' ? sentences[i] : sentences[i].replace(/\s/g, '')) : '<br>') + '</div></li>' + (i + 1 < sentences.length ? '\n' : ''));
        }

        $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * $("ol.main").html().split('\n').length.toString().concat('.').length + "px");
        $("#ocr_button").val("Xong");
        $("section.p-text div.main").css("display", "inline-block");
        $("ol.main").attr("contentEditable", "true");
      }
    </script>
  </body>
</html>