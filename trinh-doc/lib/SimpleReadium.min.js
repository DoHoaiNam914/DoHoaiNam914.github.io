navigator.epubReadingSystem={name:"Readium.js",version:"0.0.1",layoutStyle:"paginated",hasFeature:function(b,a){if(a&&a!=="1.0"){return false}if(b==="dom-manipulation"){return true}if(b==="layout-changes"){return true}if(b==="touch-events"){return false}if(b==="mouse-events"){return true}if(b==="keyboard-events"){return true}if(b==="spine-scripting"){return true}return false}};var SimpleReadiumJs=function(b,h,q,p,t){var s={};var r={};var v={};var l={};var u={};var a={};var f={};var d=function(){var z={};z.Parser=(function(){function B(C){return'"'+C.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var A={parse:function(D,K){var C={fragment:ak,range:G,path:ab,local_path:al,indexStep:P,indirectionStep:aq,terminus:F,idAssertion:aa,textLocationAssertion:af,parameter:Y,csv:E,valueNoSpace:ao,value:Z,escapedSpecialChars:ae,number:U,integer:W,space:ag,circumflex:ad,doubleQuote:ah,squareBracket:N,parentheses:L,comma:J,semicolon:an,equal:O,character:aj};if(K!==undefined){if(C[K]===undefined){throw new Error("Invalid rule name: "+B(K)+".")}}else{K="fragment"}var X=0;var am=0;var H=0;var M=[];function ap(at,ax,av){var ar=at;var aw=av-at.length;for(var au=0;au<aw;au++){ar=ax+ar}return ar}function S(au){var at=au.charCodeAt(0);var ar;var av;if(at<=255){ar="x";av=2}else{ar="u";av=4}return"\\"+ar+ap(at.toString(16).toUpperCase(),"0",av)}function Q(ar){if(X<H){return}if(X>H){H=X;M=[]}M.push(ar)}function ak(){var av,at,ar;var aw,au;aw=X;au=X;if(D.substr(X,8)==="epubcfi("){av="epubcfi(";X+=8}else{av=null;if(am===0){Q('"epubcfi("')}}if(av!==null){at=G();if(at===null){at=ab()}if(at!==null){if(D.charCodeAt(X)===41){ar=")";X++}else{ar=null;if(am===0){Q('")"')}}if(ar!==null){av=[av,at,ar]}else{av=null;X=au}}else{av=null;X=au}}else{av=null;X=au}if(av!==null){av=(function(ay,ax){return{type:"CFIAST",cfiString:ax}})(aw,av[1])}if(av===null){X=aw}return av}function G(){var ay,aw,av,au,at,ar;var az,ax;az=X;ax=X;ay=P();if(ay!==null){aw=al();if(aw!==null){if(D.charCodeAt(X)===44){av=",";X++}else{av=null;if(am===0){Q('","')}}if(av!==null){au=al();if(au!==null){if(D.charCodeAt(X)===44){at=",";X++}else{at=null;if(am===0){Q('","')}}if(at!==null){ar=al();if(ar!==null){ay=[ay,aw,av,au,at,ar]}else{ay=null;X=ax}}else{ay=null;X=ax}}else{ay=null;X=ax}}else{ay=null;X=ax}}else{ay=null;X=ax}}else{ay=null;X=ax}if(ay!==null){ay=(function(aE,aB,aD,aA,aC){return{type:"range",path:aB,localPath:aD,range1:aA,range2:aC}})(az,ay[0],ay[1],ay[3],ay[5])}if(ay===null){X=az}return ay}function ab(){var au,ar;var av,at;av=X;at=X;au=P();if(au!==null){ar=al();if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au!==null){au=(function(ay,aw,ax){return{type:"path",path:aw,localPath:ax}})(av,au[0],au[1])}if(au===null){X=av}return au}function al(){var au,ar;var av,at;av=X;at=X;ar=P();if(ar===null){ar=aq()}if(ar!==null){au=[];while(ar!==null){au.push(ar);ar=P();if(ar===null){ar=aq()}}}else{au=null}if(au!==null){ar=F();ar=ar!==null?ar:"";if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au!==null){au=(function(ay,aw,ax){return{steps:aw,termStep:ax}})(av,au[0],au[1])}if(au===null){X=av}return au}function P(){var ay,aw,au,at,ar;var az,ax,av;az=X;ax=X;if(D.charCodeAt(X)===47){ay="/";X++}else{ay=null;if(am===0){Q('"/"')}}if(ay!==null){aw=W();if(aw!==null){av=X;if(D.charCodeAt(X)===91){au="[";X++}else{au=null;if(am===0){Q('"["')}}if(au!==null){at=aa();if(at!==null){if(D.charCodeAt(X)===93){ar="]";X++}else{ar=null;if(am===0){Q('"]"')}}if(ar!==null){au=[au,at,ar]}else{au=null;X=av}}else{au=null;X=av}}else{au=null;X=av}au=au!==null?au:"";if(au!==null){ay=[ay,aw,au]}else{ay=null;X=ax}}else{ay=null;X=ax}}else{ay=null;X=ax}if(ay!==null){ay=(function(aB,aC,aA){return{type:"indexStep",stepLength:aC,idAssertion:aA[1]}})(az,ay[1],ay[2])}if(ay===null){X=az}return ay}function aq(){var ay,aw,au,at,ar;var az,ax,av;az=X;ax=X;if(D.substr(X,2)==="!/"){ay="!/";X+=2}else{ay=null;if(am===0){Q('"!/"')}}if(ay!==null){aw=W();if(aw!==null){av=X;if(D.charCodeAt(X)===91){au="[";X++}else{au=null;if(am===0){Q('"["')}}if(au!==null){at=aa();if(at!==null){if(D.charCodeAt(X)===93){ar="]";X++}else{ar=null;if(am===0){Q('"]"')}}if(ar!==null){au=[au,at,ar]}else{au=null;X=av}}else{au=null;X=av}}else{au=null;X=av}au=au!==null?au:"";if(au!==null){ay=[ay,aw,au]}else{ay=null;X=ax}}else{ay=null;X=ax}}else{ay=null;X=ax}if(ay!==null){ay=(function(aB,aC,aA){return{type:"indirectionStep",stepLength:aC,idAssertion:aA[1]}})(az,ay[1],ay[2])}if(ay===null){X=az}return ay}function F(){var ay,aw,au,at,ar;var az,ax,av;az=X;ax=X;if(D.charCodeAt(X)===58){ay=":";X++}else{ay=null;if(am===0){Q('":"')}}if(ay!==null){aw=W();if(aw!==null){av=X;if(D.charCodeAt(X)===91){au="[";X++}else{au=null;if(am===0){Q('"["')}}if(au!==null){at=af();if(at!==null){if(D.charCodeAt(X)===93){ar="]";X++}else{ar=null;if(am===0){Q('"]"')}}if(ar!==null){au=[au,at,ar]}else{au=null;X=av}}else{au=null;X=av}}else{au=null;X=av}au=au!==null?au:"";if(au!==null){ay=[ay,aw,au]}else{ay=null;X=ax}}else{ay=null;X=ax}}else{ay=null;X=ax}if(ay!==null){ay=(function(aC,aB,aA){return{type:"textTerminus",offsetValue:aB,textAssertion:aA[1]}})(az,ay[1],ay[2])}if(ay===null){X=az}return ay}function aa(){var ar;var at;at=X;ar=Z();if(ar!==null){ar=(function(av,au){return au})(at,ar)}if(ar===null){X=at}return ar}function af(){var au,ar;var av,at;av=X;at=X;au=E();au=au!==null?au:"";if(au!==null){ar=Y();ar=ar!==null?ar:"";if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au!==null){au=(function(ay,aw,ax){return{type:"textLocationAssertion",csv:aw,parameter:ax}})(av,au[0],au[1])}if(au===null){X=av}return au}function Y(){var aw,au,at,ar;var ax,av;ax=X;av=X;if(D.charCodeAt(X)===59){aw=";";X++}else{aw=null;if(am===0){Q('";"')}}if(aw!==null){au=ao();if(au!==null){if(D.charCodeAt(X)===61){at="=";X++}else{at=null;if(am===0){Q('"="')}}if(at!==null){ar=ao();if(ar!==null){aw=[aw,au,at,ar]}else{aw=null;X=av}}else{aw=null;X=av}}else{aw=null;X=av}}else{aw=null;X=av}if(aw!==null){aw=(function(aA,ay,az){return{type:"parameter",LHSValue:ay,RHSValue:az}})(ax,aw[1],aw[3])}if(aw===null){X=ax}return aw}function E(){var av,at,ar;var aw,au;aw=X;au=X;av=Z();av=av!==null?av:"";if(av!==null){if(D.charCodeAt(X)===44){at=",";X++}else{at=null;if(am===0){Q('","')}}if(at!==null){ar=Z();ar=ar!==null?ar:"";if(ar!==null){av=[av,at,ar]}else{av=null;X=au}}else{av=null;X=au}}else{av=null;X=au}if(av!==null){av=(function(az,ax,ay){return{type:"csv",preAssertion:ax,postAssertion:ay}})(aw,av[0],av[2])}if(av===null){X=aw}return av}function ao(){var at,ar;var au;au=X;ar=ae();if(ar===null){ar=aj()}if(ar!==null){at=[];while(ar!==null){at.push(ar);ar=ae();if(ar===null){ar=aj()}}}else{at=null}if(at!==null){at=(function(aw,av){return av.join("")})(au,at)}if(at===null){X=au}return at}function Z(){var at,ar;var au;au=X;ar=ae();if(ar===null){ar=aj();if(ar===null){ar=ag()}}if(ar!==null){at=[];while(ar!==null){at.push(ar);ar=ae();if(ar===null){ar=aj();if(ar===null){ar=ag()}}}}else{at=null}if(at!==null){at=(function(aw,av){return av.join("")})(au,at)}if(at===null){X=au}return at}function ae(){var au,ar;var av,at;av=X;at=X;au=ad();if(au!==null){ar=ad();if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au===null){at=X;au=ad();if(au!==null){ar=N();if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au===null){at=X;au=ad();if(au!==null){ar=L();if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au===null){at=X;au=ad();if(au!==null){ar=J();if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au===null){at=X;au=ad();if(au!==null){ar=an();if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}if(au===null){at=X;au=ad();if(au!==null){ar=O();if(ar!==null){au=[au,ar]}else{au=null;X=at}}else{au=null;X=at}}}}}}if(au!==null){au=(function(ax,aw){return aw[1]})(av,au)}if(au===null){X=av}return au}function U(){var ax,av,at,ar;var ay,aw,au;ay=X;aw=X;au=X;if(/^[1-9]/.test(D.charAt(X))){ax=D.charAt(X);X++}else{ax=null;if(am===0){Q("[1-9]")}}if(ax!==null){if(/^[0-9]/.test(D.charAt(X))){at=D.charAt(X);X++}else{at=null;if(am===0){Q("[0-9]")}}if(at!==null){av=[];while(at!==null){av.push(at);if(/^[0-9]/.test(D.charAt(X))){at=D.charAt(X);X++}else{at=null;if(am===0){Q("[0-9]")}}}}else{av=null}if(av!==null){ax=[ax,av]}else{ax=null;X=au}}else{ax=null;X=au}if(ax!==null){if(D.charCodeAt(X)===46){av=".";X++}else{av=null;if(am===0){Q('"."')}}if(av!==null){au=X;at=[];if(/^[0-9]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[0-9]")}}while(ar!==null){at.push(ar);if(/^[0-9]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[0-9]")}}}if(at!==null){if(/^[1-9]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[1-9]")}}if(ar!==null){at=[at,ar]}else{at=null;X=au}}else{at=null;X=au}if(at!==null){ax=[ax,av,at]}else{ax=null;X=aw}}else{ax=null;X=aw}}else{ax=null;X=aw}if(ax!==null){ax=(function(aA,aB,az){return aB.join("")+"."+az.join("")})(ay,ax[0],ax[2])}if(ax===null){X=ay}return ax}function W(){var av,at,ar;var aw,au;aw=X;if(D.charCodeAt(X)===48){av="0";X++}else{av=null;if(am===0){Q('"0"')}}if(av===null){au=X;if(/^[1-9]/.test(D.charAt(X))){av=D.charAt(X);X++}else{av=null;if(am===0){Q("[1-9]")}}if(av!==null){at=[];if(/^[0-9]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[0-9]")}}while(ar!==null){at.push(ar);if(/^[0-9]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[0-9]")}}}if(at!==null){av=[av,at]}else{av=null;X=au}}else{av=null;X=au}}if(av!==null){av=(function(ay,ax){if(ax==="0"){return"0"}else{return ax[0].concat(ax[1].join(""))}})(aw,av)}if(av===null){X=aw}return av}function ag(){var ar;var at;at=X;if(D.charCodeAt(X)===32){ar=" ";X++}else{ar=null;if(am===0){Q('" "')}}if(ar!==null){ar=(function(au){return" "})(at)}if(ar===null){X=at}return ar}function ad(){var ar;var at;at=X;if(D.charCodeAt(X)===94){ar="^";X++}else{ar=null;if(am===0){Q('"^"')}}if(ar!==null){ar=(function(au){return"^"})(at)}if(ar===null){X=at}return ar}function ah(){var ar;var at;at=X;if(D.charCodeAt(X)===34){ar='"';X++}else{ar=null;if(am===0){Q('"\\""')}}if(ar!==null){ar=(function(au){return'"'})(at)}if(ar===null){X=at}return ar}function N(){var ar;var at;at=X;if(D.charCodeAt(X)===91){ar="[";X++}else{ar=null;if(am===0){Q('"["')}}if(ar===null){if(D.charCodeAt(X)===93){ar="]";X++}else{ar=null;if(am===0){Q('"]"')}}}if(ar!==null){ar=(function(av,au){return au})(at,ar)}if(ar===null){X=at}return ar}function L(){var ar;var at;at=X;if(D.charCodeAt(X)===40){ar="(";X++}else{ar=null;if(am===0){Q('"("')}}if(ar===null){if(D.charCodeAt(X)===41){ar=")";X++}else{ar=null;if(am===0){Q('")"')}}}if(ar!==null){ar=(function(av,au){return au})(at,ar)}if(ar===null){X=at}return ar}function J(){var ar;var at;at=X;if(D.charCodeAt(X)===44){ar=",";X++}else{ar=null;if(am===0){Q('","')}}if(ar!==null){ar=(function(au){return","})(at)}if(ar===null){X=at}return ar}function an(){var ar;var at;at=X;if(D.charCodeAt(X)===59){ar=";";X++}else{ar=null;if(am===0){Q('";"')}}if(ar!==null){ar=(function(au){return";"})(at)}if(ar===null){X=at}return ar}function O(){var ar;var at;at=X;if(D.charCodeAt(X)===61){ar="=";X++}else{ar=null;if(am===0){Q('"="')}}if(ar!==null){ar=(function(au){return"="})(at)}if(ar===null){X=at}return ar}function aj(){var ar;var at;at=X;if(/^[a-z]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[a-z]")}}if(ar===null){if(/^[A-Z]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[A-Z]")}}if(ar===null){if(/^[0-9]/.test(D.charAt(X))){ar=D.charAt(X);X++}else{ar=null;if(am===0){Q("[0-9]")}}if(ar===null){if(D.charCodeAt(X)===45){ar="-";X++}else{ar=null;if(am===0){Q('"-"')}}if(ar===null){if(D.charCodeAt(X)===95){ar="_";X++}else{ar=null;if(am===0){Q('"_"')}}}}}}if(ar!==null){ar=(function(av,au){return au})(at,ar)}if(ar===null){X=at}return ar}function T(au){au.sort();var av=null;var at=[];for(var ar=0;ar<au.length;ar++){if(au[ar]!==av){at.push(au[ar]);av=au[ar]}}return at}function V(){var ar=1;var av=1;var aw=false;for(var at=0;at<Math.max(X,H);at++){var au=D.charAt(at);if(au==="\n"){if(!aw){ar++}av=1;aw=false}else{if(au==="\r"||au==="\u2028"||au==="\u2029"){ar++;av=1;aw=true}else{av++;aw=false}}}return{line:ar,column:av}}var R=C[K]();if(R===null||X!==D.length){var ac=Math.max(X,H);var I=ac<D.length?D.charAt(ac):null;var ai=V();throw new this.SyntaxError(T(M),I,ac,ai.line,ai.column)}return R},toSource:function(){return this._source}};A.SyntaxError=function(F,G,H,D,E){function C(K,L){var I,J;switch(K.length){case 0:I="end of input";break;case 1:I=K[0];break;default:I=K.slice(0,K.length-1).join(", ")+" or "+K[K.length-1]}J=L?B(L):"end of input";return"Expected "+I+" but "+J+" found."}this.name="SyntaxError";this.expected=F;this.found=G;this.message=C(F,G);this.offset=H;this.line=D;this.column=E};A.SyntaxError.prototype=Error.prototype;return A})();z.CFIInstructions={getNextNode:function(F,D,E,B,A){var C;if(F%2==0){C=this.elementNodeStep(F,D,E,B,A)}else{C=this.inferTargetTextNode(F,D,E,B,A)}return C},followIndirectionStep:function(J,I,G,C,A){var F=this;var E;var D;var H;var B;if(I===undefined||!I.is("iframe")){throw z.NodeTypeError(I,"expected an iframe element")}if(I.is("iframe")){E=I.contents();D=this.applyBlacklist(E.children(),G,C,A);H=$(D[0]);B=this.getNextNode(J,H,G,C,A);return B}},textTermination:function(C,B,A){var D;if(C===undefined){throw z.NodeTypeError(C,"expected a terminating node, or node list")}else{if(C.length===0){throw z.TerminusError("Text","Text offset:"+B,"no nodes found for termination condition")}}D=this.injectCFIMarkerIntoText(C,B,A);return D},targetIdMatchesIdAssertion:function(B,A){if(B.attr("id")===A){return true}else{return false}},elementNodeStep:function(I,H,G,E,B){var C;var F;var D;var A=(I/2)-1;F=this.applyBlacklist(H.children(),G,E,B);D=F.length;if(this.indexOutOfRange(A,D)){throw z.OutOfRangeError(A,D-1,"")}C=$(F[A]);return C},retrieveItemRefHref:function(B,A){return $("#"+B.attr("idref"),A).attr("href")},indexOutOfRange:function(A,B){return(A>B-1)?true:false},injectCFIMarkerIntoText:function(H,C,J){var A;var F;var I=0;var G;var E;var D;var B;for(A=0;A<=H.length;A++){if(H[A].nodeType===3){currNodeMaxIndex=(H[A].nodeValue.length-1)+I;G=C-I;if(currNodeMaxIndex>=C){E=H[A].nodeValue;H[A].nodeValue=E.slice(0,G);D=$(J).insertAfter(H.eq(A));B=$(document.createTextNode(E.slice(G,E.length)));$(B).insertAfter(D);return D}else{I=I+currNodeMaxIndex}}}throw z.TerminusError("Text","Text offset:"+C,"The offset exceeded the length of the text")},inferTargetTextNode:function(I,G,F,D,A){var J;var E;var H;var B;var C;J=this.applyBlacklist(G.contents(),F,D,A);H=(parseInt(I)+1)/2;E=1;C=J.filter(function(){if(E===H){if(this.nodeType===3){return true}else{E++;return false}}else{if(this.nodeType!==3&&this!==J.lastChild){E++}return false}});if(C.length===0){throw z.OutOfRangeError(H,E-1,"Index out of range")}return C},applyBlacklist:function(C,E,D,B){var A;A=C.filter(function(){var F=$(this);var G=true;if(E){$.each(E,function(H,I){if(F.hasClass(I)){G=false;return false}})}if(D){$.each(D,function(H,I){if(F.is(I)){G=false;return false}})}if(B){$.each(B,function(H,I){if(F.attr("id")===I){G=false;return false}})}return G});return A}};z.Interpreter={getContentDocHref:function(A,F,G,D,B){var I=$(F);var C=decodeURI(A);var H=z.Parser.parse(C);if(!H||H.type!=="CFIAST"){throw z.NodeTypeError(H,"expected CFI AST root node")}var E=$($("package",I)[0]);var J=this.interpretIndexStepNode(H.cfiString.path,E,G,D,B);foundHref=this.searchLocalPathForHref(J,I,H.cfiString.localPath,G,D,B);if(foundHref){return foundHref}else{return undefined}},injectElement:function(A,D,K,F,E,B){var C=decodeURI(A);var I=z.Parser.parse(C);var G;var H;var J;H=this.getFirstIndirectionStepNum(I);G=I.cfiString.localPath.steps[H];G.type="indexStep";J=this.interpretLocalPath(I.cfiString.localPath,H,$("html",D),F,E,B);J=this.interpretTextTerminusNode(I.cfiString.localPath.termStep,J,K);return J},injectRangeElements:function(J,C,F,D,H,E,A){var B=decodeURI(J);var L=z.Parser.parse(B);var I;var K;var M;var N;var G;K=this.getFirstIndirectionStepNum(L);I=L.cfiString.localPath.steps[K];I.type="indexStep";M=this.interpretLocalPath(L.cfiString.localPath,K,$("html",C),H,E,A);N=this.interpretLocalPath(L.cfiString.range1,0,M,H,E,A);N=this.interpretTextTerminusNode(L.cfiString.range1.termStep,N,F);G=this.interpretLocalPath(L.cfiString.range2,0,M,H,E,A);G=this.interpretTextTerminusNode(L.cfiString.range2.termStep,G,D);return{startElement:N[0],endElement:G[0]}},getTargetElement:function(A,D,F,E,B){var C=decodeURI(A);var I=z.Parser.parse(C);var G;var H;var J;H=this.getFirstIndirectionStepNum(I);G=I.cfiString.localPath.steps[H];G.type="indexStep";J=this.interpretLocalPath(I.cfiString.localPath,H,$("html",D),F,E,B);return J},getRangeTargetElements:function(H,C,F,D,A){var B=decodeURI(H);var J=z.Parser.parse(B);var G;var I;var K;var L;var E;I=this.getFirstIndirectionStepNum(J);G=J.cfiString.localPath.steps[I];G.type="indexStep";K=this.interpretLocalPath(J.cfiString.localPath,I,$("html",C),F,D,A);L=this.interpretLocalPath(J.cfiString.range1,0,K,F,D,A);E=this.interpretLocalPath(J.cfiString.range2,0,K,F,D,A);return{startElement:L[0],endElement:E[0]}},getTargetElementWithPartialCFI:function(F,C,E,D,A){var B=decodeURI(F);var H=z.Parser.parse(B);var G;var I=this.interpretIndexStepNode(H.cfiString.path,$("html",C),E,D,A);I=this.interpretLocalPath(H.cfiString.localPath,0,I,E,D,A);return I},getTextTerminusInfoWithPartialCFI:function(G,C,F,E,A){var B=decodeURI(G);var I=z.Parser.parse(B);var H;var D;var J=this.interpretIndexStepNode(I.cfiString.path,$("html",C),F,E,A);J=this.interpretLocalPath(I.cfiString.localPath,0,J,F,E,A);D=parseInt(I.cfiString.localPath.termStep.offsetValue);return{textNode:J,textOffset:D}},getFirstIndirectionStepNum:function(B){var A=0;for(A;A<=B.cfiString.localPath.steps.length-1;A++){nextStepNode=B.cfiString.localPath.steps[A];if(nextStepNode.type==="indirectionStep"){return A}}},interpretLocalPath:function(H,G,A,E,C,B){var D=G;var F;for(D;D<=H.steps.length-1;D++){F=H.steps[D];if(F.type==="indexStep"){A=this.interpretIndexStepNode(F,A,E,C,B)}else{if(F.type==="indirectionStep"){A=this.interpretIndirectionStepNode(F,A,E,C,B)}}}return A},interpretIndexStepNode:function(A,C,F,E,D){if(A===undefined||A.type!=="indexStep"){throw z.NodeTypeError(A,"expected index step node")}var B=z.CFIInstructions.getNextNode(A.stepLength,C,F,E,D);if(A.idAssertion){if(!z.CFIInstructions.targetIdMatchesIdAssertion(B,A.idAssertion)){throw z.CFIAssertionError(A.idAssertion,B.attr("id"),"Id assertion failed")}}return B},interpretIndirectionStepNode:function(F,B,E,D,C){if(F===undefined||F.type!=="indirectionStep"){throw z.NodeTypeError(F,"expected indirection step node")}var A=z.CFIInstructions.followIndirectionStep(F.stepLength,B,E,D);if(F.idAssertion){if(!z.CFIInstructions.targetIdMatchesIdAssertion(A,F.idAssertion)){throw z.CFIAssertionError(F.idAssertion,A.attr("id"),"Id assertion failed")}}return A},interpretTextTerminusNode:function(D,A,B){if(D===undefined||D.type!=="textTerminus"){throw z.NodeTypeError(D,"expected text terminus node")}var C=z.CFIInstructions.textTermination(A,D.offsetValue,B);return C},searchLocalPathForHref:function(A,F,H,E,C,B){var D=0;var G;for(D=0;D<=H.steps.length-1;D++){G=H.steps[D];if(G.type==="indexStep"){A=this.interpretIndexStepNode(G,A,E,C,B)}else{if(G.type==="indirectionStep"){A=this.interpretIndirectionStepNode(G,A,E,C,B)}}if(A.is("itemref")){return z.CFIInstructions.retrieveItemRefHref(A,F)}}return undefined}};z.NodeTypeError=function(C,B){function A(){this.node=C}A.prototype=new Error(B);A.constructor=A;return new A()};z.OutOfRangeError=function(B,C,D){function A(){this.targetIndex=B;this.maxIndex=C}A.prototype=new Error(D);A.constructor=A();return new A()};z.TerminusError=function(D,B,C){function A(){this.terminusType=D;this.terminusCondition=B}A.prototype=new Error(C);A.constructor=A();return new A()};z.CFIAssertionError=function(A,D,C){function B(){this.expectedAssertion=A;this.targetElementAssertion=D}B.prototype=new Error(C);B.constructor=B();return new B()};z.Generator={generateCharOffsetRangeComponent:function(C,I,B,K,H,E,A){var M;var L;var N;var G;var J;var D;var F;this.validateStartTextNode(C);this.validateStartTextNode(B);if(C===B){N=this.createCFITextNodeStep($(C),I,H,E,A);J=this.createCFITextNodeStep($(B),K,H,E,A);F=this.createCFIElementSteps($(C).parent(),"html",H,E,A);return F.substring(1,F.length)+","+N+","+J}else{M=document.createRange();M.setStart(C,I);M.setEnd(B,K);L=M.commonAncestorContainer;N=this.createCFITextNodeStep($(C),I,H,E,A);G=this.createCFIElementSteps($(C).parent(),L,H,E,A)+N;J=this.createCFITextNodeStep($(B),K,H,E,A);D=this.createCFIElementSteps($(B).parent(),L,H,E,A)+J;F=this.createCFIElementSteps($(L),"html",H,E,A);return F.substring(1,F.length)+","+G+","+D}},generateElementRangeComponent:function(C,B,H,E,A){var J;var I;var G;var D;var F;this.validateStartElement(C);this.validateStartElement(B);if(C===B){throw new Error("Start and end element cannot be the same for a CFI range")}J=document.createRange();J.setStart(C);J.setEnd(B);I=J.commonAncestorContainer;G=this.createCFIElementSteps($(C),I,H,E,A);D=this.createCFIElementSteps($(B),I,H,E,A);F=this.createCFIElementSteps($(I),"html",H,E,A);return F.substring(1,F.length)+","+G+","+D},generateCharacterOffsetCFIComponent:function(D,I,H,F,A){var G;var C;var E;var B;this.validateStartTextNode(D,I);G=this.createCFITextNodeStep($(D),I,H,F,A);C=this.createCFIElementSteps($(D).parent(),"html",H,F,A)+G;return C.substring(1,C.length)},generateElementCFIComponent:function(C,F,D,B){var G;var E;var A;this.validateStartElement(C);G=this.createCFIElementSteps($(C),"html",F,D,B);return G.substring(1,G.length)},generatePackageDocumentCFIComponent:function(E,C,D,B,A){this.validateContentDocumentName(E);this.validatePackageDocument(C,E);$itemRefStartNode=$("itemref[idref='"+E+"']",$(C));packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",D,B,A);return packageDocCFIComponent+"!"},generatePackageDocumentCFIComponentWithSpineIndex:function(A,D,E,C,B){$itemRefStartNode=$($("spine",D).children()[A]);packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",E,C,B);return packageDocCFIComponent+"!"},generateCompleteCFI:function(B,A){return"epubcfi("+B+A+")"},validateStartTextNode:function(B,A){if(!B){throw new z.NodeTypeError(B,"Cannot generate a character offset from a starting point that is not a text node")}else{if(B.nodeType!=3){throw new z.NodeTypeError(B,"Cannot generate a character offset from a starting point that is not a text node")}}if(A<0){throw new z.OutOfRangeError(A,0,"Character offset cannot be less than 0")}else{if(A>B.nodeValue.length){throw new z.OutOfRangeError(A,B.nodeValue.length-1,"character offset cannot be greater than the length of the text node")}}},validateStartElement:function(A){if(!A){throw new z.NodeTypeError(A,"CFI target element is undefined")}if(!(A.nodeType&&A.nodeType===1)){throw new z.NodeTypeError(A,"CFI target element is not an HTML element")}},validateContentDocumentName:function(A){if(!A){throw new Error("The idref for the content document, as found in the spine, must be supplied")}},validatePackageDocument:function(A,B){if(!A){throw new Error("A package document must be supplied to generate a CFI")}else{if($($("itemref[idref='"+B+"']",A)[0]).length===0){throw new Error("The idref of the content document could not be found in the spine")}}},createCFITextNodeStep:function(E,N,K,F,C){var D;var H;var L;var M;var O;var B;var P;var J;var G;D=E.parent();H=z.CFIInstructions.applyBlacklist(D.contents(),K,F,C);var I;var A;$.each(H,function(Q){if(this.nodeType===3){if(this===E[0]){if(I){M=A}else{M=Q}return false}I=true;if(!A){A=Q}}else{I=false;A=undefined}});L=(M*2)+1;return"/"+L+":"+N},findOriginalTextNodeCharOffset:function(D,F,I,E,A){var B;var G;var J;B=D.parent();G=z.CFIInstructions.applyBlacklist(B.contents(),I,E,A);var H;var C=-1;$.each(G,function(K){if(this.nodeType===3){if(this===D[0]){if(H){C=C+F}else{C=F}return false}else{C=C+this.length}H=true}else{H=false}});return C},createCFIElementSteps:function(J,G,H,E,A){var F;var B;var D;var K;var I;var C;F=z.CFIInstructions.applyBlacklist(J.parent().children(),H,E,A);$.each(F,function(L,M){if(this===J[0]){D=L;return false}});K=(D+1)*2;if(J.attr("id")){C="/"+K+"["+J.attr("id")+"]"}else{C="/"+K}B=J.parent();if(B.is(G)||J.is(G)){if(G==="html"){return"!"+C}else{return C}}else{return this.createCFIElementSteps(B,G,H,E,A)+C}}};var x=z.Interpreter;var y=z.Generator;var w=z.CFIInstructions;return{getContentDocHref:function(B,A){return x.getContentDocHref(B,A)},injectElement:function(E,A,B,F,D,C){return x.injectElement(E,A,B,F,D,C)},getTargetElement:function(B,A){return x.getTargetElement(B,A)},getTargetElementWithPartialCFI:function(B,A){return x.getTargetElementWithPartialCFI(B,A)},getTextTerminusInfoWithPartialCFI:function(B,A){return x.getTextTerminusInfoWithPartialCFI(B,A)},generateCharacterOffsetCFIComponent:function(B,A){return y.generateCharacterOffsetCFIComponent(B,A)},generateElementCFIComponent:function(A){return y.generateElementCFIComponent(A)},generatePackageDocumentCFIComponent:function(B,A){return y.generatePackageDocumentCFIComponent(B,A)},generatePackageDocumentCFIComponentWithSpineIndex:function(A,B){return y.generatePackageDocumentCFIComponentWithSpineIndex(A,B)},generateCompleteCFI:function(B,A){return y.generateCompleteCFI(B,A)},injectElementAtOffset:function(A,C,B){return w.injectCFIMarkerIntoText(A,C,B)},injectRangeElements:function(E,B,A,G,F,D,C){return x.injectRangeElements(E,B,A,G,F,D,C)},getRangeTargetElements:function(D,A,E,C,B){return x.getRangeTargetElements(D,A,E,C,B)},generateCharOffsetRangeComponent:function(G,B,A,C,F,E,D){return y.generateCharOffsetRangeComponent(G,B,A,C,F,E,D)},generateElementRangeComponent:function(E,A,D,C,B){return y.generateElementRangeComponent(E,A,D,C,B)}}};var c=function(B,w,y,A){var x={};x.AlternateStyleTagSelector=Backbone.Model.extend({initialize:function(){},activateAlternateStyleSet:function(C,D){var G;var E=[];var H=this;var F;if(C.length===0){return D}G=$("link[rel*='stylesheet']",D);if(G.length===0){return D}G=this._storeOriginalAttributes(G);E=this._getStyleSetTitles(G);F=this._getStyleSetTitleToActivate(G,E,C);if(F===null){return D}this._activateStyleSet(G,F);return D},_activateStyleSet:function(C,D){C.each(function(){$styleSheet=$(this);$styleSheet.attr("rel","stylesheet");if($styleSheet.attr("title")===undefined){$styleSheet[0].disabled=false}else{if($.trim($styleSheet.attr("title"))===D){$styleSheet[0].disabled=true;$styleSheet[0].disabled=false}else{$styleSheet[0].disabled=true}}});return C},_storeOriginalAttributes:function(C){var D;C.each(function(){D=$(this);if(D.data("orig-rel")===undefined){D.attr("data-orig-rel",D.attr("rel"))}});return C},_getStyleSetTitleToActivate:function(E,J,G){var H=[];var D;var C;var F;var I=[];for(D=0;D<J.length;D+=1){C=E.filter("link[title='"+J[D]+"']");C=this._removeMutuallyExclusiveAltTags(C);H.push({numAltTagMatches:this._getNumAltStyleTagMatches(C,G),styleSetTitle:J[D]})}F=(_.max(H,function(L){return L.numAltTagMatches})).numAltTagMatches;if(F===0){return null}_.each(H,function(L){if(L.numAltTagMatches===F){I.push(L.styleSetTitle)}});if(I===1){return I[0]}else{var K;for(K=0;K<I.length;K++){C=E.filter("link[title='"+I[K]+"']");if($.trim($(C[0]).attr("data-orig-rel"))==="stylesheet"){return I[K]}}return I[0]}},_getStyleSetTitles:function(C){var D=[];C.each(function(){var E=$(this).attr("title");if(!_.include(D,E)){D.push(E)}});return D},_getNumAltStyleTagMatches:function(F,C){var E=0;var D;for(D=0;D<C.length;D+=1){if(F.filter("link[class*='"+C[D]+"']").length>0){E++}}return E},_removeMutuallyExclusiveAltTags:function(D){var C;if(D.filter("link[class*='night']").length>0&&D.filter("link[class*='day']").length>0){D.each(function(){C=$(this);if(C.filter(".night").length>0){C.toggleClass("night")}if(C.filter(".day").length>0){C.toggleClass("day")}})}if(D.filter("link[class*='vertical']").length>0&&D.filter("link[class*='horizontal']").length>0){D.each(function(){C=$(this);if(C.filter(".vertical").length>0){C.toggleClass("vertical")}if(C.filter(".horizontal").length>0){C.toggleClass("horizontal")}})}return D}});x.ReflowableAnnotations=Backbone.Model.extend({defaults:{saveCallback:undefined,callbackContext:undefined},initialize:function(C,D){this.epubCFI=new d()},saveAnnotation:function(D,C){var E=this.get("saveCallback");E.call(this.get("callbackContext"),D,C)},redraw:function(){},findExistingLastPageMarker:function(C){try{var E=undefined;$.each(C.parent().contents(),function(){if($(this).hasClass("last-page")){lastPageMarkerExists=true;E=$(this).attr("data-last-page-cfi");return false}});return E}catch(D){console.log("Could not generate CFI for non-text node as first visible element on page");return undefined}},findSelectedElements:function(G,E,D,C,H,F){if(G===E){C.startElementFound=true}if(C.startElementFound===true){this.addElement(G,H,F)}if(G===D){C.endElementFound=true;return}if(G.firstChild){this.findSelectedElements(G.firstChild,E,D,C,H,F);if(C.endElementFound){return}}if(G.nextSibling){this.findSelectedElements(G.nextSibling,E,D,C,H,F);if(C.endElementFound){return}}},addElement:function(D,E,C){if(D.nodeType===Node.TEXT_NODE){E.push(D)}},getCurrentSelectionRange:function(){var C;var D=this.get("contentDocumentDOM");if(D.getSelection){C=D.getSelection();if(C.rangeCount){return C.getRangeAt(0)}}else{if(D.selection){return D.selection.createRange()}else{return undefined}}},getPaginationLeftOffset:function(){var D=$("html",this.get("contentDocumentDOM"));var C=D.css("left");var E=parseInt(C.replace("px",""));return E},getBookmarkMarker:function(C,D){return"<span class='bookmark-marker cfi-marker' id='"+D+"' data-cfi='"+C+"'></span>"},getRangeStartMarker:function(C,D){return"<span class='range-start-marker cfi-marker' id='start-"+D+"' data-cfi='"+C+"'></span>"},getRangeEndMarker:function(C,D){return"<span class='range-end-marker cfi-marker' id='end-"+D+"' data-cfi='"+C+"'></span>"}});x.ReflowableElementInfo=Backbone.Model.extend({initialize:function(){},getElemPageNumber:function(F,J,K,H,I){var C;var G=false;var L,E;var D;C=$(F);if(C.attr("epub:type")==="pagebreak"&&!C.is(":visible")){G=true;C.show()}L=F.getClientRects();if(!L||L.length<1){return -1}E=L[0][J];D=L[0].left-L[0].right;if(J==="right"&&D===0){E-=1}else{if(J==="left"&&D===0){E+=1}}E+=Math.abs(D);if(G){C.hide()}if(J==="right"){E=K-E}E-=parseInt(I.style[J],10);return Math.ceil(E/(K+H))},getElemPageNumberById:function(H,G,C,D,E){var F=$(G).find("#"+H);if(F.length==0){return -1}else{return this.getElemPageNumber(F[0],C,D,E,G)}},findVisibleCharacterOffset:function(M,J){var D;var F;var K;var G=5;var H;var I;var C;var E;var L;D=M.parent();H=$(J);I=H.position().top;C=I+H.height();F=D.offset().top;K=F+D.height();if(F<I){E=Math.abs(F-I)/D.height();characterOffsetByPercent=Math.ceil(E*M[0].length);L=Math.ceil(0.5*(M[0].length-characterOffsetByPercent))+characterOffsetByPercent}else{if(F>=I&&F<=C){L=1}else{if(F<C){L=1}}}return L},findVisibleTextNode:function(I,G,D,C){var F=0;var H;var K;var J;var E;J=$("body",I).find(":not(iframe)").contents().filter(function(){if(this.nodeType===3&&!$(this).parent().hasClass("audiError")){return true}else{return false}});K=I;if(G){H=F+D+(C*2)}else{H=F+$(K).width()}$.each(J,function(){var L=5;var P=$(this).parent();var N=P.position().left;var O=N+P.width();var M;N=Math.abs(N)<L?0:N;O=Math.abs(O-H)<L?H:O;M=this.nodeValue.replace(/\n/g,"");M=M.replace(/ /g,"");if(N<=H&&O>=F&&M.length>10){E=$(this);return false}});return E},findVisiblePageElements:function(F,H){var I=$(H).find("[id]");var J=H;var E=0;var G=0;var C=G+$(J).width();var K=E+$(J).height();var D=this.filterElementsByPosition(F,I,E,K,G,C);return D},filterElementsByPosition:function(G,F,D,I,E,H){var C=F.filter(function(K){var P=$(G).offset().top;var L=$(G).offset().left;var J=L+$(G).width();var O=P+$(G).height();var N=L>=E&&J<=H;var M=P>=D&&O<=I;return N&&M});return C}});x.ReflowableLayout=Backbone.Model.extend({initialize:function(C){this.epubCFI=new d()},initializeContentDocument:function(J,D,E,F,L,G,I,C){var H;var K=this.injectCFIElements(J,D,E);this.applySwitches(J,F);this.injectLinkHandler(J,L,G);H=this.parseTriggers(J);this.applyTriggers(J,H);$(J).attr("title");this.injectKeydownHandler(F,I,G);return K},injectCFIElements:function(G,D,H){var F=this;var C;var D;var E;C=G;D=D;_.each(D,function(K,I){if(K.contentDocSpinePos===H){try{F.epubCFI.injectElement(I,C.parentNode,K.payload,["cfi-marker","audiError"],[],["MathJax_Message"]);if(K.type==="last-page"){E=$(K.payload).attr("id")}}catch(J){console.log("Could not inject CFI");console.log(J)}}});return E},applyTriggers:function(E,D){for(var C=0;C<D.length;C++){D[C].subscribe(E.parentNode)}},parseTriggers:function(D){var C=[];$("trigger",D.parentNode).each(function(){C.push(new x.Trigger(D.parentNode))});return C},applySwitches:function(E,D){var C=function(H){var G=H.attributes["required-namespace"];if(!G){console.log("Encountered a case statement with no required-namespace");return false}var F=["http://www.w3.org/1998/Math/MathML"];return _.include(F,G)};$("switch",E.parentNode).each(function(G){var F=false;$("case",D).each(function(){if(!F&&C(D)){F=true}else{$(D).remove()}});if(F){$("default",D).remove()}})},injectMathJax:function(F){var E,C,D;E=F.parentNode;D=E.getElementsByTagName("head")[0];if(D){C=E.createElement("script");C.type="text/javascript";C.src=MathJax.Hub.config.root+"/MathJax.js?config=readium-iframe";D.appendChild(C)}},injectLinkHandler:function(D,E,C){$("a",D).click(function(F){E.call(C,F)})},injectKeydownHandler:function(E,C,D){$(E).contents().keydown(function(F){C.call(D,F)})}});x.ReflowablePageNumberLogic=Backbone.Model.extend({initialize:function(){},getPageNumbers:function(D,E,C){if(E){if(C){if(D%2===1){return[D-1,D]}else{return[D,D+1]}}else{if(D%2===1){return[D,D+1]}else{return[D-1,D]}}}else{return[D]}},getPreviousPageNumbers:function(E,D){var C=E[0]-1;if(!D){return[C]}else{return[C-1,C]}},getNextPageNumbers:function(F,E){var D=F[F.length-1];var C=D+1;if(!E){return[C]}else{return[C,C+1]}},getToggledLayoutPageNumbers:function(G,C){var F=G;var E=F.length===2?true:false;var D=[];if(E){if(F[0]===0){D[0]=1}else{D[0]=F[0]}}else{if(C){if(F[0]%2===1){D[0]=F[0]-1;D[1]=F[0]}else{D[0]=F[0];D[1]=F[0]+1}}else{if(F[0]%2===1){D[0]=F[0];D[1]=F[0]+1}else{D[0]=F[0]-1;D[1]=F[0]}}}return D},});x.ReflowablePagination=Backbone.Model.extend({defaults:{numberOfPages:0,currentPages:[1]},initialize:function(){this.pageNumberDisplayLogic=new x.ReflowablePageNumberLogic();this.on("change:numberOfPages",this.adjustCurrentPage,this)},onFirstPage:function(){var C=this.get("currentPages")[0]===1?true:this.get("currentPages")[1]===1?true:false;if(C){return true}else{return false}},onLastPage:function(){var C=this.get("currentPages")[0]===this.get("numberOfPages")?true:this.get("currentPages")[1]===this.get("numberOfPages")?true:false;if(C){return true}else{return false}},toggleTwoUp:function(D,E){var C=this.pageNumberDisplayLogic.getToggledLayoutPageNumbers(this.get("currentPages"),E);if(!D){C=this.adjustForMaxPageNumber(C)}this.set("currentPages",C)},prevPage:function(D){var C=this.pageNumberDisplayLogic.getPreviousPageNumbers(this.get("currentPages"),D);this.set("currentPages",C)},nextPage:function(C){var D=this.pageNumberDisplayLogic.getNextPageNumbers(this.get("currentPages"),C);this.set("currentPages",D)},goToPage:function(C,E,F){var D=this.pageNumberDisplayLogic.getPageNumbers(C,E,F);this.set("currentPages",D)},resetCurrentPages:function(){var D=this.get("currentPages");var C=this.adjustForMaxPageNumber(D);if(C!==D){this.set("currentPages",C)}},adjustForMaxPageNumber:function(E){var C=this.get("currentPages");var D=this.get("numberOfPages");if(E[0]>D){return[D]}else{return E}}});x.ReflowablePaginator=Backbone.Model.extend({initialize:function(C){},paginateContentDocument:function(F,L,K,H,G,M,E,C,J,N){var I=this.adjustIframeColumns(L,K,H,G,F,M,E,C,J);var D=this.setFontSize(N,K,F);return[D,I]},getColumnAxisCssName:function(){var C=Modernizr.prefixed("columnAxis")||"columnAxis";return this.createCssPropertyName(C)},getColumnGapCssName:function(){var C=Modernizr.prefixed("columnGap")||"columnGap";return this.createCssPropertyName(C)},getColumnWidthCssName:function(){var C=Modernizr.prefixed("columnWidth")||"columnWidth";return this.createCssPropertyName(C)},createCssPropertyName:function(C){return C.replace(/([A-Z])/g,function(E,D){return"-"+D.toLowerCase()}).replace(/^ms-/,"-ms-")},calcNumPages:function(I,H,D){var C,G,F,E;C=I;G=C.style[D];C.style[D]="0px";F=I.scrollWidth;this.set("lastScrollWidth",F);C.style[D]=G;E=Math.floor((F+this.gap_width)/(this.gap_width+this.page_width));if(E%2===0&&H){}return E},getFrameWidth:function(C,E,G){var D;var F=E;if(F===1){G?(D=0.95):(D=0.9)}else{if(F===2){G?(D=0.89):(D=0.8)}else{if(F===3){G?(D=0.83):(D=0.7)}else{if(F===4){G?(D=0.77):(D=0.6)}else{G?(D=0.7):(D=0.5)}}}}return Math.floor(C*D)},setFrameSize:function(E,D,F,H,I){var G=this.getFrameWidth(E,H,I).toString()+"px";var C=D.toString()+"px";$(F).parent().css("width",G);$(F).parent().css("height",C);$(F).css("width",G);$(F).css("height",C)},getBodyColumnCss:function(){var C={};C[this.getColumnAxisCssName()]="horizontal";C[this.getColumnGapCssName()]=this.gap_width.toString()+"px";C[this.getColumnWidthCssName()]=this.page_width.toString()+"px";C.position="absolute";C.width=this.page_width.toString()+"px";C.height=this.frame_height.toString()+"px";return C},accountForOffset:function(D,I,J,H,E){var G=$(D);if(I){var J=J;var C;var F=H[0]===0&&H[1]===1?true:false;if(J&&F){if(E==="rtl"){firstPageOffset=-(2*(this.page_width+this.gap_width));G.css("margin-left",firstPageOffset+"px")}else{firstPageOffset=this.page_width+(this.gap_width*2);G.css("margin-left",firstPageOffset+"px")}return 1}else{G.css("margin-left","0px");return H[0]}}else{G.css("margin-left","0px");return H[0]}},adjustIframeColumns:function(M,L,I,H,F,N,E,C,K){var G=M;var D=$(I);var J;this.setFrameSize($(H).parent().width(),$(H).parent().height(),I,K,F);this.frame_width=parseInt(D.width(),10);this.frame_height=parseInt(D.height(),10);this.gap_width=Math.floor(this.frame_width/10);this.padding_width=Math.floor(this.gap_width/2);if(F){this.page_width=Math.floor((this.frame_width-this.gap_width-(this.padding_width*2))/2)}else{this.page_width=Math.floor(this.frame_width-(this.padding_width*2))}$(L).css(this.getBodyColumnCss());$(I).css("width",this.frame_width-this.padding_width-this.padding_width);$(I).css("padding-left",this.padding_width);$(I).css("padding-right",this.padding_width);J=this.accountForOffset(I,F,N,E,C);return J},setFontSize:function(D,F,E){var C=D/10;$(F).css("font-size",C+"em");return this.calcNumPages(F,E)}});x.Trigger=function(D){var C=$(D);this.action=C.attr("action");this.ref=C.attr("ref");this.event=C.attr("ev:event");this.observer=C.attr("ev:observer");this.ref=C.attr("ref")};x.Trigger.prototype.subscribe=function(E){var C="#"+this.observer;var D=this;$(C,E).on(this.event,function(){D.execute(E)})};x.Trigger.prototype.execute=function(D){var C=$("#"+this.ref,D);switch(this.action){case"show":C.css("visibility","visible");break;case"hide":C.css("visibility","hidden");break;case"play":C[0].currentTime=0;C[0].play();break;case"pause":C[0].pause();break;case"resume":C[0].play();break;case"mute":C[0].muted=true;break;case"unmute":C[0].muted=false;break;default:console.log("do not no how to handle trigger "+this.action)}};x.ReflowablePaginationView=Backbone.View.extend({el:"<div class='flowing-wrapper clearfix' style='display:block;margin-left:auto;margin-right:auto;position:relative'>             <iframe scrolling='no'                     frameborder='0'                     height='100%'                     class='readium-flowing-content'>             </iframe>           </div>",initialize:function(D){var C=Backbone.Model.extend({});var E=Backbone.Model.extend({});this.viewerModel=new C(D.viewerSettings);this.viewerModel.set({syntheticLayout:D.viewerSettings.syntheticLayout});this.spineItemModel=new E(D.spineItem);this.epubCFIs=D.contentDocumentCFIs;this.bindings=D.bindings;this.reflowableLayout=new x.ReflowableLayout();this.reflowablePaginator=new x.ReflowablePaginator();this.reflowableElementsInfo=new x.ReflowableElementInfo();this.pages=new x.ReflowablePagination();this.spineDivider=new x.ReflowableSpineDividerView();this.$el.append(this.spineDivider.render());this.customizer=new x.ReflowableCustomizer({parentElement:this.getFlowingWrapper(),readiumFlowingContent:this.getReadiumFlowingContent(),spineDividerStyleView:this.spineDivider});this.annotations;this.cfi=new d()},destruct:function(){},render:function(C,F){var E=this;var D=this.spineItemModel.toJSON();$("iframe",this.el).attr("src",D.contentDocumentURI);$("iframe",this.el).attr("title",D.title);$(this.getReadiumFlowingContent()).on("load",function(L){if(typeof navigator.epubReadingSystem!="undefined"){var G=E.getReadiumFlowingContent();var K=G.contentWindow||G.contentDocument.parentWindow;var J=navigator.epubReadingSystem;K.navigator.epubReadingSystem=J}var H;var I=E.initializeContentDocument();E.paginateContentDocument();if(F){E.showPageByElementId(F)}else{if(I){E.showPageByElementId(I)}else{if(C){}else{E.showPageByNumber(1)}}}E.annotations=new x.ReflowableAnnotations({saveCallback:undefined,callbackContext:undefined,contentDocumentDOM:E.getEpubContentDocument().parentNode});E.trigger("contentDocumentLoaded",E.el)});return this.el},showPageByNumber:function(C){this.pages.goToPage(C,this.viewerModel.get("syntheticLayout"),this.spineItemModel.get("firstPageIsOffset"));this.showCurrentPages()},showPageByCFI:function(F){var G;var C;var E;try{if(new RegExp(/.+,.+,.+/).test(F)){G=this.cfi.getRangeTargetElements(F,$(this.getEpubContentDocument()).parent()[0]);E=G[0]}else{C=this.cfi.getTargetElement(F,$(this.getEpubContentDocument()).parent()[0]);E=C[0]}}catch(D){throw D}this.showPageByElement(E)},showPageByElementId:function(C){var D=$("#"+C,this.getEpubContentDocument())[0];if(!D){return}while(D.children.length>0){D=D.children[0]}this.showPageByElement(D)},showView:function(){this.$el.show();this.updatePageNumber()},hideView:function(){this.$el.hide()},customizeStyles:function(C,D){if(C==="margin"){this.setMargin(parseInt(D))}else{if(C==="fontSize"){this.setFontSize(parseInt(D))}else{this.customizer.setCustomStyle(C,D)}}this.paginateContentDocument()},setFontSize:function(C){if(C!==this.viewerModel.get("fontSize")){this.viewerModel.set("fontSize",C);this.paginateContentDocument()}},setMargin:function(C){if(C!==this.viewerModel.get("currentMargin")){this.viewerModel.set("currentMargin",C);this.paginateContentDocument()}},setSyntheticLayout:function(C){if(C!==this.viewerModel.get("syntheticLayout")){this.viewerModel.set("syntheticLayout",C);this.pages.toggleTwoUp(C,this.spineItemModel.get("firstPageIsOffset"));this.paginateContentDocument();this.viewerModel.get("syntheticLayout")?this.spineDivider.show():this.spineDivider.hide();this.trigger("layoutChanged",C)}},nextPage:function(){if(!this.pages.onLastPage()){var C=this.viewerModel.get("syntheticLayout");this.pages.nextPage(C);this.showCurrentPages();this.trigger("atNextPage");this.pages.onLastPage()?this.trigger("atLastPage"):undefined}else{this.trigger("atLastPage")}},previousPage:function(){if(!this.pages.onFirstPage()){var C=this.viewerModel.get("syntheticLayout");this.pages.prevPage(C);this.showCurrentPages();this.trigger("atPreviousPage");this.pages.onFirstPage()?this.trigger("atFirstPage"):undefined}else{this.trigger("atFirstPage")}},getFlowingWrapper:function(){return this.el},getReadiumFlowingContent:function(){return $(this.el).children()[0]},getEpubContentDocument:function(){return $($($(this.el).children()[0]).contents()[0]).children()[0]},keydownHandler:function(C){if(C.which==39){this.trigger("keydown-right")}if(C.which==37){this.trigger("keydown-left")}},linkClickHandler:function(C){this.trigger("epubLinkClicked",C)},updatePageNumber:function(){var D;var F=this.getEpubContentDocument();var C=this.viewerModel.get("syntheticLayout");var E=F.scrollWidth;var G=this.reflowablePaginator.get("lastScrollWidth");if(G!==E){D=this.reflowablePaginator.calcNumPages(F,C);this.pages.set("numberOfPages",D);this.reflowablePaginator.set("lastScrollWidth",E)}},paginateContentDocument:function(){var C=this.reflowablePaginator.paginateContentDocument(this.viewerModel.get("syntheticLayout"),this.offsetDirection(),this.getEpubContentDocument(),this.getReadiumFlowingContent(),this.getFlowingWrapper(),this.spineItemModel.get("firstPageIsOffset"),this.pages.get("currentPages"),this.spineItemModel.get("pageProgressionDirection"),this.viewerModel.get("currentMargin"),this.viewerModel.get("fontSize"));this.pages.set("numberOfPages",C[0]);this.viewerModel.get("syntheticLayout")?this.spineDivider.show():this.spineDivider.hide();this.redrawAnnotations();this.pages.resetCurrentPages();this.showCurrentPages()},initializeContentDocument:function(){var C=this.reflowableLayout.initializeContentDocument(this.getEpubContentDocument(),this.epubCFIs,this.spineItemModel.get("spine_index"),this.getReadiumFlowingContent(),this.linkClickHandler,this,this.keydownHandler,this.bindings);return C},showPageByElement:function(D){var C=this.reflowableElementsInfo.getElemPageNumber(D,this.offsetDirection(),this.reflowablePaginator.page_width,this.reflowablePaginator.gap_width,this.getEpubContentDocument());if(C>0){this.pages.goToPage(C,this.viewerModel.get("syntheticLayout"),this.spineItemModel.get("firstPageIsOffset"));this.showCurrentPages()}else{}},showCurrentPages:function(){var C=this;this.hideContent();C.moveViewportToPage(C.pages.get("currentPages")[0]);C.showContent();this.trigger("displayedContentChanged")},moveViewportToPage:function(C){var D=this.calcPageOffset(C).toString()+"px";$(this.getEpubContentDocument()).css(this.offsetDirection(),"-"+D)},hideContent:function(){$(this.getFlowingWrapper()).css("opacity","0")},showContent:function(){$(this.getFlowingWrapper()).css("opacity","1")},calcPageOffset:function(C){return(C-1)*(this.reflowablePaginator.page_width+this.reflowablePaginator.gap_width)},redrawAnnotations:function(){if(this.annotations){this.annotations.redraw()}},offsetDirection:function(){if(this.spineItemModel.get("pageProgressionDirection")==="rtl"){return"right"}else{return"left"}}});x.ReflowableCustomizer=Backbone.Model.extend({initialize:function(C,D){this.$parentEl=$(this.get("parentElement"));this.set("customBorder",new x.ReflowableCustomBorder({targetElement:this.get("readiumFlowingContent")}));this.set("customTheme",new x.ReflowableCustomTheme({iframeElement:this.get("readiumFlowingContent")}))},setCustomStyle:function(D,C){if(D==="reflowable-epub-border"||D==="epub-border"){this.get("customBorder").setCurrentStyle(C)}else{if(D==="reflowable-spine-divider"||D==="spine-divider"){this.get("spineDividerStyleView").setCurrentStyle(C)}else{if(D==="reflowable-page-border"||D==="page-border"){this.get("customBorder").setCurrentStyle(C);this.get("spineDividerStyleView").setCurrentStyle(C)}else{if(D==="reflowable-page-theme"){this.get("customTheme").setCurrentStyle(C)}}}}}});x.ReflowableCustomBorder=Backbone.Model.extend({initialize:function(C,D){this.$element=$(this.get("targetElement"));this.currentStyle={};if(this.get("customStyle")){this.setCurrentStyle(this.get("customStyle"))}else{this.setCurrentStyle("none")}},setCurrentStyle:function(D){var C;if(typeof D==="string"){C=this.getDefaultBorderStyle(D);if(C!==undefined){this.currentStyle=C;this.renderCurrentStyle()}}else{if(typeof D==="object"){C=this.addRequiredPositionCSS(D);this.currentStyle=C;this.renderCurrentStyle()}}},renderCurrentStyle:function(){this.$element.attr("style","");this.$element.css(this.currentStyle)},getDefaultBorderStyle:function(D){var C;if(D==="box-shadow"){return this.addRequiredPositionCSS({"box-shadow":"0 0 5px 5px rgba(80, 80, 80, 0.5)"})}else{if(D=="none"){return this.addRequiredPositionCSS({})}else{return undefined}}},addRequiredPositionCSS:function(E){var D={position:"relative","z-index":"0",top:"0px",left:"0px",width:"100%",height:"100%"};var C=_.extend(E,D);return C}});x.ReflowableSpineDividerView=Backbone.View.extend({el:"<div class='reflowing-spine-divider'></div>",initialize:function(C){this.currentStyle={};if(C&&C.customStyle){this.setCurrentStyle(C.customStyle)}else{this.setCurrentStyle("none")}},render:function(){this.renderCurrentStyle();return this.el},setCurrentStyle:function(D){var C;if(typeof D==="string"){C=this.getDefaultSpineStyle(D);if(C!==undefined){this.currentStyle=C;this.renderCurrentStyle()}}else{if(typeof D==="object"){C=this.addRequiredPositionCSS(D);this.currentStyle=C;this.renderCurrentStyle()}}},hide:function(){this.$el.hide()},show:function(){this.$el.show()},renderCurrentStyle:function(){this.$el.attr("style","");this.$el.css(this.currentStyle)},getDefaultSpineStyle:function(D){var C;if(D==="box-shadow"){return this.addRequiredPositionCSS({width:"1px",height:"93%",top:"3%","box-shadow":"0 0 5px 5px rgba(80, 80, 80, 0.5)"})}else{if(D==="none"){return this.addRequiredPositionCSS({})}else{return undefined}}},addRequiredPositionCSS:function(F){var E=F.top?F.top:"0px";var D={position:"absolute","z-index":"2",left:"50%",top:E};var C=_.extend(F,D);return C}});x.ReflowableCustomTheme=Backbone.Model.extend({initialize:function(C,D){this.currentStyle={}},setCurrentStyle:function(C){var D;if(typeof C==="string"){D=this.getDefaultThemeStyle(C);if(D!==undefined){this.currentStyle=D;this.renderCurrentStyle()}}else{if(typeof C==="object"){D=C;this.currentStyle=D;this.renderCurrentStyle()}}},renderCurrentStyle:function(){$(this.getContentDocumentHTML()).attr("style","");$(this.getContentDocumentHTML()).css(this.currentStyle)},getDefaultThemeStyle:function(C){if(C==="none"){return{"background-color":"white",color:"black","mo-color":"#777"}}else{if(C==="vancouver"){return{"background-color":"#DDD",color:"#576b96","mo-color":"#777"}}else{if(C==="night"){return{"background-color":"#141414",color:"white","mo-color":"#666"}}else{if(C==="ballard"){return{"background-color":"#576b96",color:"#DDD","mo-color":"#888"}}else{return undefined}}}}},getContentDocumentHTML:function(){return $("body",this.get("iframeElement").contentDocument)[0]}});var z=new x.ReflowablePaginationView({spineItem:B,viewerSettings:w,contentDocumentCFIs:y,bindings:A});return{render:function(C,D){return z.render(C,D)},nextPage:function(){return z.nextPage()},previousPage:function(){return z.previousPage()},showPageByHashFragment:function(C){return z.showPageByElementId(C)},showPageByNumber:function(C){return z.showPageByNumber(C)},showPageByCFI:function(C){return z.showPageByCFI(C)},onFirstPage:function(){return z.pages.onFirstPage()},onLastPage:function(){return z.pages.onLastPage()},showPagesView:function(){return z.showView()},hidePagesView:function(){return z.hideView()},numberOfPages:function(){return z.pages.get("numberOfPages")},currentPage:function(){return z.pages.get("currentPages")},setSyntheticLayout:function(C){return z.setSyntheticLayout(C)},on:function(D,E,C){return z.on(D,E,C)},off:function(C,D){return z.off(C,D)},resizeContent:function(){return z.paginateContentDocument()},customize:function(C,D){z.customizeStyles(C,D);return this}}};var n=function(z,w){var y={};y.PageNumberDisplayLogic=Backbone.Model.extend({initialize:function(){},getPageNumbers:function(B,C,A){if(C){if(A==="rtl"){if(this.pageIsLeft(B)){if(this.pageIsRight(B-1)){return[B-1,B]}else{return[B]}}else{if(this.pageIsRight(B)){if(this.pageIsLeft(B+1)){return[B,B+1]}else{return[B]}}else{return[B]}}}else{if(this.pageIsLeft(B)){if(this.pageIsRight(B+1)){return[B,B+1]}else{return[B]}}else{if(this.pageIsRight(B)){if(this.pageIsLeft(B-1)){return[B-1,B]}else{return[B]}}else{return[B]}}}}else{return[B]}},getPreviousPageNumbers:function(E,D,A){var B=E;var C=B[0]-1;if(!D){return[C]}else{if(A==="rtl"){if(this.pageIsLeft(C)&&this.pageIsRight(C-1)){return[C-1,C]}else{return[C]}}else{if(this.pageIsRight(C)&&this.pageIsLeft(C-1)){return[C-1,C]}else{return[C]}}}},getNextPageNumbers:function(E,C,A){var B=E;var D=B[B.length-1]+1;if(!C){return[D]}else{if(A==="rtl"){if(this.pageIsRight(D)&&this.pageIsLeft(D+1)){return[D,D+1]}else{return[D]}}else{if(this.pageIsLeft(D)&&this.pageIsRight(D+1)){return[D,D+1]}else{return[D]}}}},getPageNumbersForTwoUp:function(F,E,C){var D=F;var B=D.length===2?true:false;var A=[];if(B){if(D[0]===0){A[0]=1}else{A[0]=D[0]}}else{if(C==="rtl"){if(this.pageIsLeft(D[0])){if(this.pageIsRight(D[0]-1)){A[0]=D[0]-1;A[1]=D[0]}else{A[0]=D[0]}}else{if(this.pageIsRight(D[0])){if(this.pageIsLeft(D[0]+1)){A[0]=D[0];A[1]=D[0]+1}else{A[0]=D[0]}}else{A[0]=D[0]}}}else{if(this.pageIsLeft(D[0])){if(this.pageIsRight(D[0]+1)){A[0]=D[0];A[1]=D[0]+1}else{A[0]=D[0]}}else{if(this.pageIsRight(D[0])){if(this.pageIsLeft(D[0]-1)){A[0]=D[0]-1;A[1]=D[0]}else{A[0]=D[0]}}else{A[0]=D[0]}}}}return A},pageIsRight:function(B){var A=B-1;var C=this.get("spineObjects")[A];if(C!==undefined&&C.pageSpread==="right"){return true}else{return false}},pageIsLeft:function(B){var A=B-1;var C=this.get("spineObjects")[A];if(C!==undefined&&C.pageSpread==="left"){return true}else{return false}},pageIsCenter:function(B){var A=B-1;var C=this.get("spineObjects")[A];if(C!==undefined&&C.pageSpread==="center"){return true}else{return false}}});y.FixedPageViews=Backbone.Model.extend({defaults:function(){return{fixedPages:[],currentPages:[1],}},initialize:function(A,B){this.fixedPagination=new y.PageNumberDisplayLogic({spineObjects:this.get("spineObjects")});this.set("pageProgressionDirection",this.get("spineObjects")[0].pageProgressionDirection)},renderFixedPages:function(D,C,B,A){if(C.syntheticLayout){this.set("currentPages",[1,2])}this.loadPageViews(C);this.renderAll(D,B,A)},nextPage:function(B,A){var C;if(!this.onLastPage()){C=this.fixedPagination.getNextPageNumbers(this.get("currentPages"),B,this.get("pageProgressionDirection"));this.resetCurrentPages(C);A.trigger("atNextPage");A.trigger("displayedContentChanged");this.onLastPage()?A.trigger("atLastPage"):undefined}else{A.trigger("atLastPage")}},previousPage:function(B,A){var C;if(!this.onFirstPage()){C=this.fixedPagination.getPreviousPageNumbers(this.get("currentPages"),B,this.get("pageProgressionDirection"));this.resetCurrentPages(C);A.trigger("atPreviousPage");A.trigger("displayedContentChanged");this.onFirstPage()?A.trigger("atFirstPage"):undefined}else{A.trigger("atFirstPage")}},onFirstPage:function(){if(this.get("currentPages")[0]<=1){return true}return false},onLastPage:function(){if(this.get("currentPages")[0]){if(this.get("currentPages")[0]>=this.numberOfPages()){return true}}if(this.get("currentPages")[1]){if(this.get("currentPages")[1]>=this.numberOfPages()){return true}}return false},showPageNumber:function(B,E){var C;var A;var D=this.fixedPagination.getPageNumbers(B,E,this.get("pageProgressionDirection"));this.resetCurrentPages(D)},setSyntheticLayout:function(A){var B;if(A){_.each(this.get("fixedPages"),function(C){C.fixedPageView.setSyntheticPageSpreadStyle()})}else{_.each(this.get("fixedPages"),function(C){C.fixedPageView.setSinglePageSpreadStyle()})}B=this.fixedPagination.getPageNumbersForTwoUp(this.get("currentPages"),undefined,this.get("pageProgressionDirection"));this.resetCurrentPages(B)},getPageViewInfo:function(B){var A=B-1;return this.get("fixedPages")[A]},hidePageViews:function(){_.each(this.get("fixedPages"),function(A){A.fixedPageView.hidePage()})},numberOfPages:function(){return this.get("fixedPages").length},loadPageViews:function(B){var A=this;_.each(this.get("spineObjects"),function(E){var C;var D;if(E.fixedLayoutType==="image"){C=A.initializeImagePage(E.pageSpread,E.contentDocumentURI,B)}else{C=A.initializeFixedPage(E.pageSpread,E.contentDocumentURI,B)}D={fixedPageView:C,pageType:E.fixedLayoutType,isRendered:false,spineIndex:E.spineIndex,pageSpread:E.pageSpread};A.get("fixedPages").push(D)})},renderAll:function(E,D,B){var C=this;var A=this.get("fixedPages").length;_.each(this.get("fixedPages"),function(F){F.fixedPageView.on("contentDocumentLoaded",function(G){F.isRendered=true;F.fixedPageView.hidePage();A=A-1;if(A===0){C.trigger("epubLoaded")}});C.addPageViewToDom(E,F.fixedPageView.render(false,undefined,D,B))});setTimeout(function(){if(A!=0){}},1000)},addPageViewToDom:function(B,A){$(B).append(A)},resetCurrentPages:function(A){this.set("currentPages",A);this.hidePageViews();if(A[0]!==undefined&&A[0]!==null){this.getPageViewInfo(A[0]).fixedPageView.showPage()}if(A[1]!==undefined&&A[1]!==null){this.getPageViewInfo(A[1]).fixedPageView.showPage()}},initializeImagePage:function(A,B,C){return new y.ImagePageView({pageSpread:A,imageSrc:B,viewerSettings:C})},initializeFixedPage:function(A,C,B){return new y.FixedPageView({pageSpread:A,iframeSrc:C,viewerSettings:B})},resizePageViews:function(){_.each(this.get("fixedPages"),function(A){A.fixedPageView.setPageSize()})}});y.FixedSizing=Backbone.Model.extend({initialize:function(A){this.metaSize={width:undefined,height:undefined};this.transformedPageSize={}},updateMetaSize:function(){var D;var B=this.get("contentDocument");var F=$("meta[name=viewport]",B).attr("content");if(!F){F=$("meta[name=viewbox]",B).attr("content")}if(F){var C=this.parseSize(F);if(C){this.metaSize.width=C.width;this.metaSize.height=C.height}}else{if($(B).is("IMG")){D=$(B)}else{D=$(B).find("img")}var E=D.width();var A=D.height();if(E>0){this.metaSize.width=E;this.metaSize.height=A}}},fitToScreen:function(F,E){var D=this.metaSize;if(D.width==0){return}var A=F/D.width;var B=E/D.height;var G=Math.min(A,B);var C=this.generateTransformCSS(G);this.transformedPageSize.width=Math.ceil(G*D.width);this.transformedPageSize.height=Math.ceil(G*D.height);C.width=D.width;C.height=D.height;return C},parseSize:function(D){var E=D.replace(/\s/g,"").split(",");var G={};var C;var A;for(var B=0;B<E.length;B++){var F=E[B].split("=");if(F.length===2){G[F[0]]=F[1]}}C=Number.NaN;A=Number.NaN;if(G.width){C=parseInt(G.width)}if(G.height){A=parseInt(G.height)}if(!isNaN(C)&&!isNaN(A)){return{width:C,height:A}}return undefined},generateTransformCSS:function(C){var B="scale("+C+")";var A={};A[this.modernizrCssPrefix("transform")]=B;return A},modernizrCssPrefix:function(A){var B=Modernizr.prefixed(A);return B.replace(/([A-Z])/g,function(D,C){return"-"+C.toLowerCase()}).replace(/^ms-/,"-ms-")},});y.FixedLayoutStyle=Backbone.Model.extend({initialize:function(){},getSinglePageSpreadCSS:function(){return{position:"absolute",overflow:"hidden",height:"100%",width:"50%","-webkit-transform-origin":"top left","-moz-transform-origin":"top left","-o-transform-origin":"top left","-ms-transform-origin":"top left",left:"0%"}},getPageSpreadLeftCSS:function(){return{position:"absolute",overflow:"hidden",height:"100%",width:"50%",right:"50%",left:"","-webkit-transform-origin":"top right","-moz-transform-origin":"top right","-o-transform-origin":"top right","-ms-transform-origin":"top right","background-color":"#FFF"}},getPageSpreadRightCSS:function(){return{position:"absolute",overflow:"hidden",height:"100%",width:"50%",left:"50%","-webkit-transform-origin":"top left","-moz-transform-origin":"top left","-o-transform-origin":"top left","-ms-transform-origin":"top left","background-color":"#FFF"}},getPageSpreadCenterCSS:function(){return{position:"absolute",overflow:"hidden",height:"100%",width:"100%",left:"50%","z-index":"11","background-color":"#FFF"}}});y.FixedPageView=Backbone.View.extend({el:"<div class='fixed-page-wrapper'>             <iframe scrolling='no'                     frameborder='0'                     marginwidth='0'                     marginheight='0'                     style='height:100%;width:100%;'                     class='fixed-content'>             </iframe>           </div>",initialize:function(A){this.sizing;this.styles=new y.FixedLayoutStyle();this.pageSpread=A.pageSpread;this.iframeSrc=A.iframeSrc;if(A.viewerSettings.syntheticLayout){this.setSyntheticPageSpreadStyle()}else{this.setSinglePageSpreadStyle()}},render:function(A,C,E,B){var D=this;this.get$iframe().attr("src",this.iframeSrc);this.get$iframe().on("load",function(){if(typeof navigator.epubReadingSystem!="undefined"){var F=D.get$iframe()[0];var H=F.contentWindow||F.contentDocument.parentWindow;var G=navigator.epubReadingSystem;H.navigator.epubReadingSystem=G}D.sizing=new y.FixedSizing({contentDocument:D.get$iframe()[0].contentDocument});D.injectLinkHandler(D.get$iframe(),E,B);D.setPageSize();D.trigger("contentDocumentLoaded")});return this.el},get$iframe:function(){return $("iframe",this.$el)},hidePage:function(){this.$el.hide()},showPage:function(){this.$el.show()},getTransformedWidth:function(){return this.sizing.transformedPageSize.width},getTransformedHeight:function(){return this.sizing.transformedPageSize.height},setSinglePageSpreadStyle:function(){var A;this.$el.css(this.styles.getSinglePageSpreadCSS());this.setPageSize()},setSyntheticPageSpreadStyle:function(){var A=this.pageSpread;var B;if(A==="left"){this.$el.css(this.styles.getPageSpreadLeftCSS())}else{if(A==="right"){this.$el.css(this.styles.getPageSpreadRightCSS())}else{if(A==="center"){this.$el.css(this.styles.getPageSpreadCenterCSS())}}}this.setPageSize()},setPageSize:function(){var B=this.$el.parent().parent();if(this.sizing!==undefined){var A;this.sizing.updateMetaSize();A=this.sizing.fitToScreen(B.width(),B.height());this.$el.css(A)}},injectLinkHandler:function(C,D,A){var B=this;$("a",C).on("click",function(E){D.call(A,E)})}});y.ImagePageView=Backbone.View.extend({el:"<div class='fixed-page-wrapper' style='height:100%;'>             <img src='#'' alt=''/>           </div>",initialize:function(A){this.sizing;this.styles=new y.FixedLayoutStyle();this.pageSpread=A.pageSpread;this.imageSrc=A.imageSrc;if(A.viewerSettings.syntheticLayout){this.setSyntheticPageSpreadStyle()}else{this.setSinglePageSpreadStyle()}},render:function(A,C,E,B){var D=this;$("img",this.$el).attr("src",this.imageSrc);this.$("img").on("load",function(){D.sizing=new y.FixedSizing({contentDocument:$("img",this.el)[0]});D.setPageSize();D.trigger("contentDocumentLoaded")});return this.el},hidePage:function(){this.$el.hide()},showPage:function(){this.$el.show()},getTransformedWidth:function(){return this.sizing.transformedPageSize.width},getTransformedHeight:function(){return this.sizing.transformedPageSize.height},setSinglePageSpreadStyle:function(){var A;this.$el.css(this.styles.getSinglePageSpreadCSS());this.setPageSize()},setSyntheticPageSpreadStyle:function(){var A=this.pageSpread;var B;if(A==="left"){this.$el.css(this.styles.getPageSpreadLeftCSS())}else{if(A==="right"){this.$el.css(this.styles.getPageSpreadRightCSS())}else{if(A==="center"){this.$el.css(this.styles.getPageSpreadCenterCSS())}}}this.setPageSize()},setPageSize:function(){var B=this.$el.parent().parent();if(this.sizing!==undefined){var A;this.sizing.updateMetaSize();A=this.sizing.fitToScreen(B.width(),B.height());this.$el.css(A)}}});y.FixedPaginationView=Backbone.View.extend({el:"<div class='fixed-pages-view' style='position:relative; height:100%'>             <div class='fixed-spine-divider' style='position:absolute;z-index:2;width:1px;left:50%;top:3%;height:93%;'></div>           </div>",initialize:function(A){var B=this;this.fixedPageViews=new y.FixedPageViews({spineObjects:A.spineObjects});this.viewerSettings=A.viewerSettings;this.fixedPageViews.on("epubLoaded",function(){B.trigger("contentDocumentLoaded");B.createEpubBorder();B.$el.css("opacity","1")},this);this.customizer=new y.FixedCustomizer()},render:function(A,B){this.fixedPageViews.renderFixedPages(this.$el[0],this.viewerSettings,this.linkClickHandler,this);return this.el},nextPage:function(){this.fixedPageViews.nextPage(this.viewerSettings.syntheticLayout,this)},previousPage:function(){this.fixedPageViews.previousPage(this.viewerSettings.syntheticLayout,this)},setSyntheticLayout:function(A){if(A&&this.viewerSettings.syntheticLayout===false){this.viewerSettings.syntheticLayout=true;this.fixedPageViews.setSyntheticLayout(true);$(".fixed-spine-divider",this.$el).show();this.createEpubBorder();this.trigger("layoutChanged",true)}else{if(!A&&this.viewerSettings.syntheticLayout===true){this.viewerSettings.syntheticLayout=false;this.fixedPageViews.setSyntheticLayout(false);$(".fixed-spine-divider",this.$el).hide();this.createEpubBorder();this.trigger("layoutChanged",false)}}},showPageNumber:function(A){var B=this.fixedPageViews.get("currentPages");this.fixedPageViews.showPageNumber(A,this.viewerSettings.syntheticLayout);if(B!=this.fixedPageViews.get("currentPages")){this.trigger("displayedContentChanged")}},showPagesView:function(){var A=this.fixedPageViews.get("currentPages")[0];this.$el.show();this.fixedPageViews.showPageNumber(A,this.viewerSettings.syntheticLayout)},hidePagesView:function(){this.$el.hide();this.fixedPageViews.hidePageViews()},resizePageViews:function(){this.fixedPageViews.resizePageViews();this.createEpubBorder();this.trigger("displayedContentChanged")},customize:function(B,A){this.customizer.setCustomStyle(B,A,this.fixedPageViews.get("fixedPages"),this.el,$(".fixed-spine-divider",this.$el)[0],this.viewerSettings.syntheticLayout)},destruct:function(){this.off("epubLoaded")},linkClickHandler:function(A){this.trigger("epubLinkClicked",A)},createEpubBorder:function(){var D=this.fixedPageViews.get("currentPages");var A;var C;var E;var B;if(this.viewerSettings.syntheticLayout){C=this.getSyntheticBorderSize()}else{C=this.getSinglePageBorderSize()}E=this.$el.outerWidth(true);B=this.$el.outerHeight(true);if(C.width<E){this.setHorizontalMarginsForBorder(C.width,E)}else{if(C.height<B){this.setVerticalMarginsForBorder(C.height,B)}}},setHorizontalMarginsForBorder:function(E,A){var C=5;var D=A-E;var B=Math.ceil(D/2)-C;this.$el.css({"margin-left":B,"margin-right":B})},setVerticalMarginsForBorder:function(A,D){var C=5;var E=D-A;var B=Math.ceil(E/2)-C;this.$el.css({"margin-top":B,"margin-bottom":B})},getSinglePageBorderSize:function(){var B;var A=this.fixedPageViews.get("currentPages")[0];currentPage=this.fixedPageViews.getPageViewInfo(A).fixedPageView;return{height:currentPage.getTransformedHeight(),width:currentPage.getTransformedWidth(),}},getSyntheticBorderSize:function(){var G;var D;var C;var B;var F=this.fixedPageViews.get("currentPages")[0];var A=this.fixedPageViews.get("currentPages")[1];var E=2;G=this.fixedPageViews.getPageViewInfo(F).fixedPageView;if(A!==undefined){D=this.fixedPageViews.getPageViewInfo(A).fixedPageView;C=Math.max(G.getTransformedHeight(),D.getTransformedHeight());B=Math.max(G.getTransformedWidth(),D.getTransformedWidth())*E}else{C=G.getTransformedHeight();B=G.getTransformedWidth()*E}return{height:C,width:B,}}});y.FixedCustomizer=Backbone.Model.extend({initialize:function(A,B){this.set("customPageBorder",new y.FixedCustomPageBorder());this.set("customEpubBorder",new y.FixedCustomEpubBorder());this.set("customSpineDivider",new y.FixedCustomSpineDivider())},setCustomStyle:function(F,D,G,B,C,A){var E=this;if(F==="fixed-epub-border"||F==="epub-border"){E.get("customEpubBorder").setCurrentStyle(D,B)}else{if(F==="fixed-spine-divider"||F==="spine-divider"){this.get("customSpineDivider").setCurrentStyle(D,C)}else{if(F==="fixed-page-border"||F==="page-border"){E.get("customPageBorder").setCurrentStyle(D,G)}else{if(F==="fixed-page-border-left"){E.get("customPageBorder").setCurrentStyle(D,G,"left")}else{if(F==="fixed-page-border-right"){E.get("customPageBorder").setCurrentStyle(D,G,"right")}}}}}}});y.FixedCustomPageBorder=Backbone.Model.extend({initialize:function(A,B){this.lastSetStyle={}},setCurrentStyle:function(C,E,A){var D=this;var B;if(typeof C==="string"){_.each(E,function(F){if(A&&F.pageSpread!==A){return}var G=F.fixedPageView.$el;if(A==="left"){B=D.getPageSpreadDefaultBorderStyle(C,"left")}else{if(A==="right"){B=D.getPageSpreadDefaultBorderStyle(C,"right")}else{B=D.getDefaultBorderStyle(C)}}B=D.keepRequiredCSS(B);if(B!==undefined){D.removeLastSetStyle(G);D.renderCurrentStyle(G,B)}});this.setAllCurrentStyles(B)}else{if(typeof C==="object"){B=D.keepRequiredCSS(C);_.each(E,function(F){D.removeLastSetStyle($element);D.renderCurrentStyle($element,B)});this.setAllCurrentStyles(B)}}},renderCurrentStyle:function(A,B){A.css(B)},getPageSpreadDefaultBorderStyle:function(C,A){var B;if(C==="box-shadow"){if(A==="left"){return{"box-shadow":"0px 0px 5px 5px rgba(80, 80, 80, 0.5)"}}else{if(A==="right"){return{"box-shadow":"0px 0px 5px 5px rgba(80, 80, 80, 0.5)"}}else{return undefined}}}else{if(C=="none"){return{}}else{return undefined}}},getDefaultBorderStyle:function(B){var A;if(B==="box-shadow"){return{"box-shadow":"0 0 5px 5px rgba(80, 80, 80, 0.5)"}}else{if(B=="none"){return{}}else{return undefined}}},setAllCurrentStyles:function(A){this.lastSetStyle=_.extend(this.lastSetStyle,A)},keepRequiredCSS:function(B){var A=["position","z-index","top","left","width","height"];_.each(A,function(C){if(!B.hasOwnProperty(C)){delete B[C]}});return B},removeLastSetStyle:function(A){_.each(this.lastSetStyle,function(B,C){A.css(C,"")})}});y.FixedCustomEpubBorder=Backbone.Model.extend({initialize:function(A,B){this.lastSetStyle={}},setCurrentStyle:function(D,C){var E=this;var B;var A=$(C);if(typeof D==="string"){B=E.getDefaultBorderStyle(D);B=E.keepRequiredCSS(B);if(B!==undefined){E.removeLastSetStyle(A);E.renderCurrentStyle(A,B)}this.setAllCurrentStyles(B)}else{if(typeof D==="object"){B=E.keepRequiredCSS(D);E.removeLastSetStyle(A);E.renderCurrentStyle(A,B);this.setAllCurrentStyles(B)}}},renderCurrentStyle:function(A,B){A.css(B)},getDefaultBorderStyle:function(B){var A;if(B==="box-shadow"){return{"box-shadow":"0 0 5px 5px rgba(80, 80, 80, 0.5)"}}else{if(B=="none"){return{}}else{return undefined}}},setAllCurrentStyles:function(A){this.lastSetStyle=_.extend(this.lastSetStyle,A)},keepRequiredCSS:function(B){var A=["position","z-index","top","left","width","height"];_.each(A,function(C){if(!B.hasOwnProperty(C)){delete B[C]}});return B},removeLastSetStyle:function(A){_.each(this.lastSetStyle,function(B,C){A.css(C,"")})}});y.FixedCustomSpineDivider=Backbone.Model.extend({initialize:function(A,B){this.lastSetStyle={}},setCurrentStyle:function(C,D){var E=this;var B;var A=$(D);if(typeof C==="string"){B=E.getDefaultSpineStyle(C);B=E.keepRequiredCSS(B);if(B!==undefined){E.removeLastSetStyle(A);E.renderCurrentStyle(A,B)}this.setAllCurrentStyles(B)}else{if(typeof C==="object"){B=E.keepRequiredCSS(C);E.removeLastSetStyle(A);E.renderCurrentStyle(A,B);this.setAllCurrentStyles(B)}}},renderCurrentStyle:function(A,B){A.css(B)},getDefaultSpineStyle:function(B){var A;if(B==="box-shadow"){return{"box-shadow":"0 0 5px 5px rgba(80, 80, 80, 0.5)"}}else{if(B=="none"){return{}}else{return undefined}}},setAllCurrentStyles:function(A){this.lastSetStyle=_.extend(this.lastSetStyle,A)},keepRequiredCSS:function(B){var A=["position","z-index","top","left","width","height"];_.each(A,function(C){if(!B.hasOwnProperty(C)){delete B[C]}});return B},removeLastSetStyle:function(A){_.each(this.lastSetStyle,function(B,C){A.css(C,"")})}});var x=new y.FixedPaginationView({spineObjects:z,viewerSettings:w});return{render:function(A,B){return x.render(A,B)},nextPage:function(){return x.nextPage()},previousPage:function(){return x.previousPage()},showPageByHashFragment:function(A){return},showPageByNumber:function(A){return x.showPageNumber(A)},showPageByCFI:function(A){return},onFirstPage:function(){return x.fixedPageViews.onFirstPage()},onLastPage:function(){return x.fixedPageViews.onLastPage()},showPagesView:function(){return x.showPagesView()},hidePagesView:function(){return x.hidePagesView()},numberOfPages:function(){return x.fixedPageViews.get("fixedPages").length},currentPage:function(){return x.fixedPageViews.get("currentPages")},setSyntheticLayout:function(A){return x.setSyntheticLayout(A)},on:function(B,C,A){return x.on(B,C,A)},off:function(A,B){return x.off(A,B)},resizeContent:function(){return x.resizePageViews()},customize:function(B,A){x.customize(B,A);return this}}};var j=function(x,z){var w={};w.PackageDocumentParser=Backbone.Model.extend({initialize:function(A,C){this.packageDocumentURI=new URI(this.get("packageDocumentURI"));var B=this.get("packageDocumentXML");if(typeof(B)==="string"){var D=new window.DOMParser;xmlDom=D.parseFromString(B,"text/xml");this.set({xmlDom:xmlDom})}else{throw new Error("XML string representation of package document is required")}},parse:function(){var A,B,D,C;var C=this.get("xmlDom");A={};A.metadata=this.getJsonMetadata(C);A.bindings=this.getJsonBindings(C);A.spine=this.getJsonSpine(C);A.manifest=this.getJsonManifest(C);A.paginate_backwards=this.paginateBackwards(C);D=this.getCoverHref(C);if(D){A.metadata.cover_href=D}if(A.metadata.layout==="pre-paginated"){A.metadata.fixed_layout=true}A.spine=this.parseSpineProperties(A.spine);return A},getJsonSpine:function(){var A;var B=[];var C=this.get("xmlDom");A=$("spine",C).children();$.each(A,function(D,G){var E=$(G);var F={idref:E.attr("idref")?E.attr("idref"):"",linear:E.attr("linear")?E.attr("linear"):"",properties:E.attr("properties")?E.attr("properties"):""};B.push(F)});return B},getJsonMetadata:function(){var C=this.get("xmlDom");var A=$("metadata",C);var B={};B.active_class=$("meta[property='media:active-class']",A).text();B.author=$("creator",A).text();B.description=$("description",A).text();B.epub_version=$("package",C).attr("version")?$("package",C).attr("version"):"";B.id=$("identifier",A).text();B.language=$("language",A).text();B.layout=$("meta[property='rendition:layout']",A).text();B.modified_date=$("meta[property='dcterms:modified']",A).text();B.ncx=$("spine",C).attr("toc")?$("spine",C).attr("toc"):"";B.orientation=$("meta[property='rendition:orientation']",A).text();B.page_prog_dir=$("spine",C).attr("page-progression-direction")?$("spine",C).attr("page-progression-direction"):"";B.pubdate=$("date",A).text();B.publisher=$("publisher",A).text();B.rights=$("rights").text();B.spread=$("meta[property='rendition:spread']",A).text();B.title=$("title",A).text();return B},getJsonManifest:function(){var B=this;var D=this.get("xmlDom");var C=$("manifest",D).children();var A=[];$.each(C,function(F,H){var E=$(H);var G=E.attr("href")?E.attr("href"):"";var I={contentDocumentURI:B.resolveURI(G),href:G,id:E.attr("id")?E.attr("id"):"",media_overlay:E.attr("media-overlay")?E.attr("media-overlay"):"",media_type:E.attr("media-type")?E.attr("media-type"):"",properties:E.attr("properties")?E.attr("properties"):""};A.push(I)});return A},getJsonBindings:function(){var B=this.get("xmlDom");var A=$("bindings",B).children();var C=[];$.each(A,function(F,D){var E=$(D);var G={handler:E.attr("handler")?E.attr("handler"):"",media_type:E.attr("media-type")?E.attr("media-type"):""};C.push(G)});return C},getCoverHref:function(){var E=this.get("xmlDom");var C;var D;C=E.getElementsByTagName("manifest")[0];D=$('item[properties~="cover-image"]',C);if(D.length===1&&D.attr("href")){return D.attr("href")}var A=$('meta[name="cover"]',E);var B=A.attr("content");if(A.length===1&&B){D=$('item[id="'+B+'"]',C);if(D.length===1&&D.attr("href")){return D.attr("href")}}D=$("#cover",C);if(D.length===1&&D.attr("href")){return D.attr("href")}return null},parseSpineProperties:function(D){var A=function(H){var F={};var G=H.split(" ");for(var E=0;E<G.length;E++){if(G[E]==="rendition:page-spread-center"){F.page_spread="center"}if(G[E]==="page-spread-left"){F.page_spread="left"}if(G[E]==="page-spread-right"){F.page_spread="right"}if(G[E]==="page-spread-right"){F.page_spread="right"}if(G[E]==="rendition:layout-reflowable"){F.fixed_flow=false}if(G[E]==="rendition:layout-pre-paginated"){F.fixed_flow=true}}return F};for(var B=0;B<D.length;B++){var C=A(D[B].properties);_.extend(D[B],C)}return D},paginateBackwards:function(){var A=this.get("xmlDom");return $("spine",A).attr("page-progression-direction")==="rtl"},resolveURI:function(B){var A=new URI(B);var C=A.absoluteTo(this.packageDocumentURI);return C.toString()}});var y=new w.PackageDocumentParser({packageDocumentURI:x,packageDocumentXML:z});return{parse:function(){return y.parse()}}};var k=function(w,z){var x={};x.ManifestItem=Backbone.Model.extend({isSvg:function(){return this.get("media_type")==="image/svg+xml"},isImage:function(){var A=this.get("media_type");if(A&&A.indexOf("image/")>-1){return A!=="image/svg+xml"}return false}});x.Manifest=Backbone.Collection.extend({model:x.ManifestItem});x.Metadata=Backbone.Model.extend({});x.PageSpreadProperty=Backbone.Model.extend({initialize:function(){this.CENTER_PAGE="center_page";this.LEFT_PAGE="left_page";this.RIGHT_PAGE="right_page"},inferiBooksPageSpread:function(A,B){var C=A+1;if(C===1){return this.CENTER_PAGE}else{if(C%2===0&&C===B){return this.CENTER_PAGE}else{if(C%2===1){return this.RIGHT_PAGE}else{return this.LEFT_PAGE}}}},getPageSpreadFromProperties:function(A){if(A==="left"){return this.LEFT_PAGE}else{if(A==="right"){return this.RIGHT_PAGE}else{if(A==="center"){return this.CENTER_PAGE}else{return""}}}},inferUnassignedPageSpread:function(B,E,F){var A;var D;if(E.at(B).get("page_spread")==="left"||E.at(B).get("page_spread")==="right"||E.at(B).get("page_spread")==="center"){return this.getPageSpreadFromProperties(E.at(B).get("page_spread"))}else{if(B===0){return F==="rtl"?this.RIGHT_PAGE:this.LEFT_PAGE}else{for(var C=B-1;C>=0;C--){if(C===0||E.at(C).get("page_spread")){A=this.lastSpecifiedPageSpread(E.at(C).get("page_spread"),F);D=B-C;if(D%2===0){return A==="left"?this.LEFT_PAGE:A==="right"?this.RIGHT_PAGE:F==="rtl"?this.LEFT_PAGE:this.RIGHT_PAGE}else{return A==="left"?this.RIGHT_PAGE:A==="right"?this.LEFT_PAGE:F==="rtl"?this.RIGHT_PAGE:this.LEFT_PAGE}}}}}},lastSpecifiedPageSpread:function(A,B){if(A&&A!==""){return A}else{return B==="rtl"?"right":"left"}}});x.SpineItem=x.ManifestItem.extend({defaults:{pageSpreadClass:""},initialize:function(){},isFixedLayout:function(){if(this.isSvg()||this.isImage()){return true}if(typeof this.get("fixed_flow")!=="undefined"){return this.get("fixed_flow")}return false},firstPageOffset:function(){var D=!this.isFixedLayout();var B=this.get("page_prog_dir")==="rtl"?true:false;var A=this.get("page_spread")==="left"?true:false;var C=this.get("page_spread")==="right"?true:false;if(C&&A){C=false;A=false}if(D){if(B){if(A){return true}}else{if(C){return true}}}return false},});x.Spine=Backbone.Collection.extend({model:x.SpineItem,});x.PackageDocument=Backbone.Model.extend({initialize:function(A,B){var C=this.get("packageDocumentObject");this.manifest=new x.Manifest(C.manifest);this.spine=new x.Spine(C.spine);this.metadata=new x.Metadata(C.metadata);this.bindings=new x.Spine(C.bindings);this.pageSpreadProperty=new x.PageSpreadProperty();if(this.isFixedLayout()){this.assignPageSpreadClass()}},getSpineInfo:function(){var A=this;var B=[];this.spine.each(function(C){B.push(A.generateSpineInfo(C))});return{spine:B,bindings:this.bindings.toJSON()}},isFixedLayout:function(){if(this.metadata.get("fixed_layout")){return true}else{return false}},getManifestItemById:function(B){var A=this.manifest.find(function(C){if(C.get("id")===B){return C}});if(A){return A.toJSON()}else{return undefined}},getManifestItemByIdref:function(A){var B=this.getManifestItemById(A);if(B){return B}else{return undefined}},getSpineItemByIdref:function(B){var A=this.getSpineModelByIdref(B);if(A){return A.toJSON()}else{return undefined}},getSpineItem:function(A){var B=this.spine.at(A);if(B){return B.toJSON()}else{return undefined}},spineLength:function(){return this.spine.length},getNextLinearSpinePosition:function(A){var B=this.spine;if(A===undefined||A<0){A=0;if(B.at(A).get("linear")!=="no"){return A}}while(A<this.spineLength()-1){A+=1;if(B.at(A).get("linear")!=="no"){return A}}return undefined},getPrevLinearSpinePosition:function(A){var B=this.spine;if(A===undefined||A>this.spineLength()-1){A=this.spineLength()-1;if(B.at(A).get("linear")!=="no"){return A}}while(A>0){A-=1;if(B.at(A).get("linear")!=="no"){return A}}return undefined},hasNextSection:function(A){if(A>=0&&A<=this.spineLength()-1){return this.getNextLinearSpinePosition(A)>-1}else{return false}},hasPrevSection:function(A){if(A>=0&&A<=this.spineLength()-1){return this.getPrevLinearSpinePosition(A)>-1}else{return false}},pageProgressionDirection:function(){if(this.metadata.get("page_prog_dir")==="rtl"){return"rtl"}else{if(this.metadata.get("page_prog_dir")==="default"){return"default"}else{return"ltr"}}},getSpineIndexByHref:function(A){var B=this.getSpineModelFromHref(A);return this.getSpineIndex(B)},getBindingByHandler:function(A){var B=this.bindings.find(function(C){if(C.get("handler")===A){return C}});if(B){return B.toJSON()}else{return undefined}},generateSpineInfo:function(D){var A=false;var B=undefined;var C=this.getManifestModelByIdref(D.get("idref"));if(D.isFixedLayout()||this.isFixedLayout()){A=true;if(C.isSvg()){B="svg"}else{if(C.isImage()){B="image"}else{B="xhtml"}}}return{contentDocumentURI:this.getManifestItemByIdref(D.get("idref")).contentDocumentURI,title:this.metadata.get("title"),firstPageIsOffset:false,pageProgressionDirection:this.pageProgressionDirection(),spineIndex:this.getSpineIndex(D),pageSpread:D.get("page_spread"),isFixedLayout:A,fixedLayoutType:B,mediaType:C.get("media_type")}},getPackageDocumentDOM:function(){var B=new window.DOMParser;var A=B.parseFromString(this.get("packageDocument"),"text/xml");return A},getToc:function(){var B=this.getTocItem();if(B){var A=B.get("contentDocumentURI");return A}return null},getSpineModelFromHref:function(A){var D=this;var E=new URI(A);var B=E.filename();var C;this.manifest.each(function(G){var F=new URI(G.get("href"));var H=F.filename();if(H===B){C=D.getSpineModelByIdref(G.get("id"))}});return C},getSpineModelByIdref:function(B){var A=this.spine.find(function(C){if(C.get("idref")===B){return C}});return A},getManifestModelByIdref:function(A){var B=this.manifest.find(function(C){if(C.get("id")===A){return C}});return B},getSpineIndex:function(A){return this.spine.indexOf(A)},assignPageSpreadClass:function(){var C=this;var A;var B;if(this.metadata.get("apple_fixed")){B=this.spine.length;this.spine.each(function(E,D){A=C.pageSpreadProperty.inferiBooksPageSpread(D,B);E.set({pageSpreadClass:A})})}else{this.spine.each(function(E,D){if(E.get("page_spread")){A=C.pageSpreadProperty.getPageSpreadFromProperties(E.get("page_spread"));E.set({pageSpreadClass:A})}else{A=C.pageSpreadProperty.inferUnassignedPageSpread(D,C.spine,C.pageProgressionDirection());E.set({pageSpreadClass:A})}})}},getTocItem:function(){var C=this.manifest;var B=this.metadata;var A=this.metadata.get("ncx");var D=C.find(function(E){if(E.get("properties").indexOf("nav")!==-1){return true}else{return false}});if(D){return D}if(A&&A.length>0){return C.find(function(E){return E.get("id")===A})}return null}});var y=new x.PackageDocument({packageDocumentObject:w,packageDocument:z});return{getSpineInfo:function(){return y.getSpineInfo()},isFixedLayout:function(){return y.isFixedLayout()},getManifestItemById:function(A){return y.getManifestItemById(A)},getManifestItemByIdref:function(A){return y.getManifestItemByIdref(A)},getSpineItemByIdref:function(A){return y.getSpineItemByIdref(A)},getSpineItemByIndex:function(A){return y.getSpineItem(A)},spineLength:function(){return y.spineLength()},getNextLinearSpinePosition:function(A){return y.getNextLinearSpinePosition(A)},getPrevLinearSpinePosition:function(A){return y.getPrevLinearSpinePosition(A)},hasNextSection:function(A){return y.hasNextSection(A)},hasPrevSection:function(A){return y.hasPrevSection(A)},pageProgressionDirection:function(){return y.pageProgressionDirection()},getSpineIndexByHref:function(A){return y.getSpineIndexByHref(A)},getPackageDocumentDOM:function(){return y.getPackageDocumentDOM()},getToc:function(){return y.getToc()}}};var g=function(A,w,C,y,z){var x={};x.LoadStrategy=Backbone.Model.extend({defaults:{numFixedPagesPerView:100},initialize:function(D,E){},loadSpineItems:function(K,J,E){var L;var G;var D=[];var F;var H=[];var I;var F;for(L=0;L<=this.get("spineInfo").length-1;L++){G=this.get("spineInfo")[L];if(G.isFixedLayout){D.push(G);if(D.length===this.get("numFixedPagesPerView")){I=this.loadFixedPagesView(D,K);H.push(I);D=[];continue}F=this.get("spineInfo")[L+1];if(F){if(!F.isFixedLayout){I=this.loadFixedPagesView(D,K);H.push(I);D=[]}}else{I=this.loadFixedPagesView(D,K);H.push(I);D=[]}}else{if(G.shouldScroll){}else{I=this.loadReflowablePagesView(G,K,J,E);H.push(I)}}}return H},loadReflowablePagesView:function(F,I,G,H){var D=new c(F,I,G,H);var E={pagesView:D,spineIndexes:[F.spineIndex],isRendered:false,type:"reflowable"};return E},loadFixedPagesView:function(D,H){var E=new n(D,H);var F=[];_.each(D,function(I){F.push(I.spineIndex)});var G={pagesView:E,spineIndexes:F,isRendered:false,type:"fixed"};return G}});x.EpubReader=Backbone.Model.extend({defaults:function(){return{loadedPagesViews:[],currentPagesViewIndex:0,pagesViewEventList:[]}},initialize:function(D,E){var F=this.get("spineInfo");this.set("spine",F.spine);this.set("bindings",F.bindings);this.set("annotations",F.annotations);this.get("viewerSettings").customStyles=[];this.loadStrategy=new x.LoadStrategy({spineInfo:this.get("spine")});this.cfi=new d()},loadSpineItems:function(){var D=this.loadStrategy.loadSpineItems(this.get("viewerSettings"),this.get("annotations"),this.get("bindings"));this.set("loadedPagesViews",D);if(this.get("renderStrategy")==="eager"){this.eagerRenderStrategy()}else{if(this.get("renderStrategy")==="lazy"){this.trigger("epubLoaded")}}},numberOfLoadedPagesViews:function(){return this.get("loadedPagesViews").length},hasNextPagesView:function(){return this.get("currentPagesViewIndex")<this.numberOfLoadedPagesViews()-1?true:false},hasPreviousPagesView:function(){return this.get("currentPagesViewIndex")>0?true:false},getCurrentPagesView:function(){return this.get("loadedPagesViews")[this.get("currentPagesViewIndex")].pagesView},renderPagesView:function(E,I,D){var G;var H;var F=this;if(E>=0&&E<this.numberOfLoadedPagesViews()){this.hideRenderedViews();this.set({currentPagesViewIndex:E});G=this.getCurrentPagesViewInfo();H=G.pagesView;if(G.isRendered){H.showPagesView();this.applyPreferences(H);this.fitCurrentPagesView();I.call(D,H)}else{H.on("contentDocumentLoaded",function(J){H.showPagesView();F.applyPreferences(H);_.each(F.get("pagesViewEventList"),function(K){H.on(K.eventName,K.callback,K.callbackContext)});I.call(D,H)},this);$(this.get("parentElement")).append(H.render(false,undefined));F.setLastRenderSize(G,$(F.get("parentElement")).height(),$(F.get("parentElement")).width());G.isRendered=true}}},renderNextPagesView:function(F,D){var E=this.get("currentPagesViewIndex")+1;this.renderPagesView(E,function(G){G.showPageByNumber(1);F.call(D)},D)},renderPreviousPagesView:function(F,D){var E=this.get("currentPagesViewIndex")-1;this.renderPagesView(E,function(G){G.showPageByNumber(G.numberOfPages());F.call(D)},D)},attachEventHandler:function(E,F,D){this.get("pagesViewEventList").push({eventName:E,callback:F,callbackContext:D});_.each(this.get("loadedPagesViews"),function(G){G.pagesView.on(E,F,D)},this)},removeEventHandler:function(E){var F=this;var D=[];_.each(this.get("pagesViewEventList"),function(H,G){if(H.eventName===E){D.push(G)}});D.reverse();_.each(D,function(G){F.get("pagesViewEventList").splice(G,1)});_.each(this.get("loadedPagesViews"),function(G){G.pagesView.off(E)},this)},fitCurrentPagesView:function(){var D=this.get("parentElement").height();var E=this.get("parentElement").width();var F=this.getCurrentPagesViewInfo();var G=F.lastRenderHeight!==D?true:false;var H=F.lastRenderWidth!==E?true:false;if(G||H){this.setLastRenderSize(F,D,E);F.pagesView.resizeContent()}},eagerRenderStrategy:function(){var D=this;var E=this.get("loadedPagesViews").length;_.each(this.get("loadedPagesViews"),function(F){F.pagesView.on("contentDocumentLoaded",function(G){F.isRendered=true;F.pagesView.hidePagesView();E=E-1;if(E===0){D.trigger("epubLoaded")}_.each(D.get("pagesViewEventList"),function(H){F.pagesView.on(H.eventName,H.callback,H.callbackContext)})});$(D.get("parentElement")).append(F.pagesView.render(false,undefined));D.setLastRenderSize(F,$(D.get("parentElement")).height(),$(D.get("parentElement")).width())});setTimeout(function(){if(E!=0){}},1000)},getCurrentPagesViewInfo:function(){return this.get("loadedPagesViews")[this.get("currentPagesViewIndex")]},hideRenderedViews:function(){_.each(this.get("loadedPagesViews"),function(D){if(D.isRendered){D.pagesView.hidePagesView()}})},calculatePageNumberInfo:function(){var F=this;var D=0;var E;_.each(this.get("loadedPagesViews"),function(G){if(F.getCurrentPagesView()===G.pagesView){E=D+G.pagesView.currentPage()[0]}if(G.isRendered){D+=G.pagesView.numberOfPages()}});return{numPages:D,currentPage:E}},findSpineIndex:function(F){var D=F;var E;E=_.find(this.get("spine"),function(J,H){var I=new URI(J.contentDocumentURI);var G=I.filename();if(F.trim()===G.trim()){return true}});return E.spineIndex},getPagesViewInfo:function(D){var E=_.find(this.get("loadedPagesViews"),function(H,F){var G=_.find(H.spineIndexes,function(I){if(I===D){return true}});if(G!==undefined&&G!==null){return true}});return E},getPagesViewIndex:function(D){var E;_.find(this.get("loadedPagesViews"),function(H,F){var G=_.find(H.spineIndexes,function(I){if(I===D){return true}});if(G!==undefined&&G!==null){E=F;return true}});return E},applyPreferences:function(E){var D=this.get("viewerSettings");E.setSyntheticLayout(D.syntheticLayout);E.customize("margin",D.currentMargin+"");E.customize("fontSize",D.fontSize+"");_.each(D.customStyles,function(F){E.customize(F.customProperty,F.styleNameOrCSSObject)})},setLastRenderSize:function(F,D,E){F.lastRenderHeight=D;F.lastRenderWidth=E}});x.EpubReaderView=Backbone.View.extend({pageSetEvents:{contentDocumentLoaded:false,epubLinkClicked:true,atNextPage:false,atPreviousPage:false,atFirstPage:false,atLastPage:false,layoutChanged:false,displayedContentChanged:false},initialize:function(D){var E=this;this.packageDocumentDOM=D.packageDocumentDOM;this.reader=new x.EpubReader({spineInfo:D.spineInfo,viewerSettings:D.viewerSettings,parentElement:D.readerElement,renderStrategy:D.renderStrategy});this.reader.on("epubLoaded",function(){E.trigger("epubLoaded")},this);this.startPropogatingEvents();this.readerBoundElement=D.readerElement;this.cfi=new d()},render:function(){$(this.readerBoundElement).css("opacity","0");this.setElement(this.readerBoundElement);this.reader.loadSpineItems();return this.el},showSpineItem:function(D,H,E){var G=this;var F=this.reader.getPagesViewIndex(D);this.$el.css("opacity","0");this.reader.renderPagesView(F,function(){var I=this.reader.getCurrentPagesViewInfo();if(I.type==="fixed"){pageNumber=G.getPageNumber(I,D);I.pagesView.showPageByNumber(pageNumber)}else{I.pagesView.showPageByNumber(1)}G.$el.css("opacity","1");H.call(E)},this)},showPageByCFI:function(H,J,F){var E;var D;var I;try{E=this.cfi.getContentDocHref(H,this.packageDocumentDOM);D=this.reader.findSpineIndex(E);this.showSpineItem(D,function(){I=this.reader.getCurrentPagesView();I.showPageByCFI(H);J.call(F)},this)}catch(G){throw G}},showPageByElementId:function(D,F,G,E){this.showSpineItem(D,function(){this.reader.getCurrentPagesView().showPageByHashFragment(F);G.call(E)},this)},nextPage:function(G,D){var E=this;var F=this.reader.getCurrentPagesView();if(F.onLastPage()){if(this.reader.hasNextPagesView()){this.$el.css("opacity","0");this.reader.renderNextPagesView(function(){E.$el.css("opacity","1");E.trigger("atNextPage");G.call(D)},this)}else{this.trigger("atLastPage");G.call(D)}}else{F.nextPage();if(F.onLastPage()&&!this.reader.hasNextPagesView()){E.trigger("atLastPage")}}},previousPage:function(G,D){var E=this;var F=this.reader.getCurrentPagesView();if(F.onFirstPage()){if(this.reader.hasPreviousPagesView()){this.$el.css("opacity","0");this.reader.renderPreviousPagesView(function(){E.$el.css("opacity","1");E.trigger("atPreviousPage");G.call(D)},this)}else{this.trigger("atFirstPage");G.call(D)}}else{F.previousPage();if(F.onFirstPage()&&!this.reader.hasPreviousPagesView()){E.trigger("atFirstPage")}}},customize:function(E,D){var F;if(E==="fontSize"){this.setFontSize(parseInt(D))}else{if(E==="margin"){this.setMargin(parseInt(D))}else{F=this.reader.getCurrentPagesView();F.customize(E,D);this.reader.get("viewerSettings")["customStyles"].push({customProperty:E,styleNameOrCSSObject:D})}}},setFontSize:function(D){var E=this.reader.getCurrentPagesView();E.setFontSize(D);this.reader.get("viewerSettings").fontSize=D},setMargin:function(D){var E=this.reader.getCurrentPagesView();E.setMargin(D);this.reader.get("viewerSettings").currentMargin=D},setSyntheticLayout:function(D){var E=this.reader.getCurrentPagesView();E.setSyntheticLayout(D);this.reader.get("viewerSettings").syntheticLayout=D},getNumberOfPages:function(){return this.reader.calculatePageNumberInfo().numPages},getCurrentPage:function(){return this.reader.calculatePageNumberInfo().currentPage},getViewerSettings:function(){return this.reader.get("viewerSettings")},attachEventHandler:function(E,F,D){if(this.canHandlePageSetEvent(E)){this.reader.attachEventHandler(E,F,D)}else{this.on(E,F,D)}},removeEventHandler:function(D){if(this.canHandlePageSetEvent(D)){this.reader.removeEventHandler(D,callback,callbackContext)}else{this.off(D)}},getSpineIndexFromCFI:function(G){try{var F=this.cfi.getContentDocHref(G,this.packageDocumentDOM);var D=this.reader.findSpineIndex(F);return D}catch(E){throw E}},getPageNumber:function(D,F){var G=D.spineIndexes;var E=undefined;_.each(G,function(H,I){if(H===F){E=I+1;return true}});return E},canHandlePageSetEvent:function(D){if(this.pageSetEvents[D]===true){return true}else{return false}},startPropogatingEvents:function(){this.reader.attachEventHandler("atNextPage",function(){this.trigger("atNextPage")},this);this.reader.attachEventHandler("atPreviousPage",function(){this.trigger("atPreviousPage")},this);this.reader.attachEventHandler("layoutChanged",function(D){this.trigger("layoutChanged",D)},this);this.reader.attachEventHandler("displayedContentChanged",function(){this.trigger("displayedContentChanged")},this)}});var B=new x.EpubReaderView({readerElement:A,spineInfo:w,viewerSettings:C,packageDocumentDOM:y,renderStrategy:z});return{render:function(){return B.render()},showSpineItem:function(D,F,E){return B.showSpineItem(D,F,E)},showPageByCFI:function(E,F,D){return B.showPageByCFI(E,F,D)},showPageByElementId:function(D,G,F,E){return B.showPageByElementId(D,G,F,E)},nextPage:function(E,D){return B.nextPage(E,D)},previousPage:function(E,D){return B.previousPage(E,D)},setFontSize:function(D){return B.setFontSize(D)},setMargin:function(D){return B.setMargin(D)},setTheme:function(D){return B.setTheme(D)},setSyntheticLayout:function(D){return B.setSyntheticLayout(D)},getNumberOfPages:function(){return B.getNumberOfPages()},getCurrentPage:function(){return B.getCurrentPage()},on:function(E,F,D){return B.attachEventHandler(E,F,D)},off:function(D){return B.removeEventHandler(D)},getViewerSettings:function(){return B.getViewerSettings()},resizeContent:function(){return B.reader.fitCurrentPagesView()},customize:function(E,D){B.customize(E,D);return this}}};var o=new j(q,p);var e=(new window.DOMParser()).parseFromString(p,"text/xml");var i=new k(o.parse(),p);var m=new g(b,i.getSpineInfo(),h,e,t);return{render:function(){return m.render()},showSpineItem:function(w,y,x){return m.showSpineItem(w,y,x)},showPageByCFI:function(x,y,w){return m.showPageByCFI(x,y,w)},showPageByElementId:function(w,z,y,x){return m.showPageByElementId(w,z,y,x)},nextPage:function(x,w){return m.nextPage(x,w)},previousPage:function(x,w){return m.previousPage(x,w)},setFontSize:function(w){return m.setFontSize(w)},setMargin:function(w){return m.setMargin(w)},setTheme:function(w){return m.setTheme(w)},setSyntheticLayout:function(w){return m.setSyntheticLayout(w)},getNumberOfPages:function(){return m.getNumberOfPages()},getCurrentPage:function(){return m.getCurrentPage.call(m)},on:function(x,y,w){return m.on(x,y,w)},off:function(w){return m.off(w)},getViewerSettings:function(){return m.getViewerSettings()},resizeContent:function(){return m.resizeContent()},customize:function(w,x){m.customize(w,x);return this}}};