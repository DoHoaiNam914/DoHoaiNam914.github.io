<!DOCTYPE html>
<html class="hltr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, user-scalable=0, maximum-scale=1">
    <title>Trình dịch Microsoft cho Light Novel - DoHoaiNam Pages</title>
    <link rel="stylesheet" href="../css/styles/dohoainam-kadokawa-style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="../js/js.cookie.js"></script>
  </head>
  <body>
    <form>
      <div style="position: fixed; right: 8px; top: 8px;">
        <select id="background_select">
          <option value="white">Trắng</option>
          <option value="black">Đen</option>
          <option value="sepia">Sepia</option>
          <option value="cream">Kem</option>
        </select>
      </div>
    </form>
    <form>
      <div style="bottom: 8px; position: fixed; left: 8px;">
        <input id="edit_button" type="button" value="Xong">
      </div>
      <div style="bottom: 8px; position: fixed; right: 8px;">
        <select id="language_select">
          <option value="">Translate</option>
          <option value="zh-CHS">Chinese Simplified</option>
          <option value="zh-CHT">Chinese Traditional</option>
          <option value="en">English</option>
          <option value="ja">Japanese</option>
          <option value="vi">Vietnamese</option>
        </select>
      </div>
    </form>
    <section class="p-text">
      <ol class="main" style="display: none;"></ol>
      <div style="text-align: center;"><textarea name="textarea" style="background: transparent; border: 0; border-style: none; color: inherit; font-family: inherit; font-size: inherit; height: 80vh; margin: 0; padding: 0; width: 100%;">Viết gì đó tại đây</textarea></div>
    </section>
    <script>
      var orignalTextElement;
      var translationTextElement;

      var prevLang;

      $("#background_select").change(function () {
        if (this.value !== 'white') {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != null ? document.documentElement.getAttribute('style').replace(/ black;/g, '').replace(/black;/g, '').replace(/ sepia;/g, '').replace(/sepia;/g, '').replace(/ cream;/g, '').replace(/cream;/g, '').concat(' ' + this.value.concat(';')) : this.value.concat(';'));
          Cookies.set("background", this.value, { expires: 365 });
        } else {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != null ? document.documentElement.getAttribute('style').replace(/ black;/g, '').replace(/black;/g, '').replace(/ sepia;/g, '').replace(/sepia;/g, '').replace(/ cream;/g, '').replace(/cream;/g, '') : "");
          Cookies.remove("background");
        }
      });

      $(document).ready(() => $("#background_select").val(Cookies.get("background") || "white").change());
      $("ol.main").on("input", () => $("ol.main").css("padding-left", 24 + 8 * words.length.toString().length + "px"));
      $("#edit_button").on("click", function () {
        if ($("#edit_button").val() === 'Chỉnh sửa' && $("textarea").css("display") === 'none') {
          if ($("ol.main").html() === '') {
            $("ol.main").hide();
            $("textarea").show();
          } else {
            $("ol.main").attr("contentEditable", "true");
          }

          $("#edit_button").val("Xong");
        } else {
          if ($("textarea").css("display") === 'none') {
            $("ol.main").attr("contentEditable", "false");

            if ($("ol.main").html() === null || $("ol.main").html() === '<li><div class="main"></div></li>' || $("ol.main").html() === '<li><div class="main"><br></div></li>') {
              $("#language_select").val("");
              $("ol.main").html(null);
            }
          } else {
            var words = document.querySelector('textarea').value.split('\n');
            $("ol.main").html(null);

            for (let i = 0; i < words.length; i++) {
              $("ol.main").append('<li><div class="main">' + (words[i] !== '' ? words[i] : '<br>') + '</div></li>' + (i + 1 < words.length ? '\n' : ''));
            }

            $("textarea").hide();
            $("ol.main").css("padding-left", 24 + 8 * words.length.toString().length + "px");
            $("ol.main").show();
          }

          $("#edit_button").val("Chỉnh sửa");
        }
      });

      $("#language_select").on("change", function () {
        if ($("#edit_button").val() !== 'Xong') {
          if ($("#language_select").val() !== '') {
            let toLang = $("#language_select").val();

            if (toLang.includes(prevLang) && $("ol.main").html() === orignalTextElement) {
              $("ol.main").html(translationTextElement);
            } else {
              let accessToken = getMicrosoftTranslatorAccessToken();

              if (accessToken !== null) {
                let xhr = new XMLHttpRequest();

                let words = document.querySelector('ol.main').innerHTML.replace(/<li>/g, '').replace(/<\/li>/g, '').split('\n');
                orignalTextElement = $("ol.main").html();
                $("ol.main").html(null);

                for (let i = 0; i < words.length; i++) {
                  const data = JSON.stringify([
                    {
                      "Text": words[i]
                    }
                  ]);

                  xhr.onreadystatechange = function () {
                    if (this.readyState === this.DONE) {
                      $("ol.main").append('<li>' + JSON.parse(this.responseText.replace(/\[\{/g, '{').replace(/\}\]/g, '}')).translations.text + '</li>' + (i + 1 < words.length ? '\n' : ''));
                    }
                  };

                  xhr.open("POST", "https://api.cognitive.microsofttranslator.com/translate?to=" + toLang + "&api-version=3.0&includeSentenceLength=true", false);
                  xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
                  xhr.setRequestHeader("Content-Type", "application/json");

                  xhr.send(data);
                }

                prevLang = toLang;
              }
            }
          } else {
            translationTextElement = $("ol.main").html();
            $("ol.main").html(orignalTextElement);
          }
        } else {
          $("#language_select").val("");
        }
      });

      function getMicrosoftTranslatorAccessToken() {
        let accessToken;
        let settings = {
          async: false,
          url: 'https://edge.microsoft.com/translate/auth',
          method: 'GET'
        };

        $.ajax(settings).done(response => accessToken = response);
        return accessToken;
      }
    </script>
  </body>
</html>