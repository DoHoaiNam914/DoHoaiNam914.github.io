<!DOCTYPE html>
<html class="hltr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, user-scalable=0, maximum-scale=1">
    <title>Máy dịch cho Light Novel - DoHoaiNam Pages</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="../js/js.cookie-1.5.1.js"></script>
    <link rel="stylesheet" href="../css/styles/dohoainam-kadokawa-style.css">
  </head>
  <body>
    <form>
      <div class="notranslate" style="bottom: 8px; left: 8px; position: fixed;">
        <select id="background_select">
          <option value="white">Trắng</option>
          <option value="black">Đen</option>
          <option value="sepia">Sepia</option>
          <option value="cream">Kem</option>
        </select>
      </div>
    </form>
    <form>
      <div class="notranslate" style="bottom: 8px; position: fixed; right: 8px;">
        <select id="service_select">
          <option value="">Văn bản gốc</option>
          <option value="google">Google Dịch</option>
          <option value="microsoft">Trình dịch Microsoft</option>
        </select>
        <select id="language_select">
          <option value="vi">Việt</option>
          <option value="en">Anh</option>
          <option value="ja">Nhật</option>
          <option value="zh-CN">Trung (Giản thể)</option>
          <option value="zh-TW">Trung (Phổn thể)</option>
        </select>
        <input id="edit_button" type="button" value="Xong">
      </div>
    </form>
    <section class="p-text">
      <ol class="main" style="display: none;"></ol>
      <div style="text-align: center;"><textarea name="textarea" style="background: transparent; border: 0; border-style: none; color: inherit; font-family: inherit; font-size: inherit; height: 80vh; margin: 0; padding: 0; width: 100%;">Viết gì đó tại đây</textarea></div>
    </section>
    <script>
      var orignalText;

      var service = $("#service_select").val();

      var googleLang;
      var googleQueryText;

      var microsoftLang;
      var microsoftQueryText;

      var googleTranslationText;
      var microsoftTranslationText;

      $("#background_select").change(function () {
        if (!this.value.includes('white')) {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != null ? document.documentElement.getAttribute('style').replace(/ black;/g, '').replace(/black;/g, '').replace(/ sepia;/g, '').replace(/sepia;/g, '').replace(/ cream;/g, '').replace(/cream;/g, '').concat(' ' + this.value.concat(';')) : this.value.concat(';'));
          $.cookie('background', this.value, { expires: 365 });
        } else {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != null ? document.documentElement.getAttribute('style').replace(/ black;/g, '').replace(/black;/g, '').replace(/ sepia;/g, '').replace(/sepia;/g, '').replace(/ cream;/g, '').replace(/cream;/g, '') : "");
          $.removeCookie('background');
        }
      });

      $(document).ready(() => $("#background_select").val($.cookie('background') || "white").change());
      $("ol.main").on("input", () => $("ol.main").css("padding-left", 24 + 8 * words.length.toString().length + "px"));
      $("#edit_button").on("click", function () {
        if ($("#edit_button").val() === 'Chỉnh sửa' && $("textarea").css("display") === 'none') {
          if ($("ol.main").html() === '') {
            $("ol.main").hide();
            $("textarea").show();
          } else {
            $("ol.main").attr("contentEditable", "true");
          }

          $("#edit_button").val("Xong");
        } else {
          if ($("textarea").css("display") === 'none') {
            $("ol.main").attr("contentEditable", "false");

            if ($("ol.main").html() == null || $("ol.main").html() === '<li><div class="main"></div></li>' || $("ol.main").html() === '<li><div class="main"><br></div></li>') {
              $("#service_select").val("");
              $("ol.main").html(null);
              orignalText = $("ol.main").html();
            }
          } else {
            var words = document.querySelector('textarea').value.split('\n');
            $("ol.main").html(null);

            for (let i = 0; i < words.length; i++) {
              $("ol.main").append('<li><div class="main">' + (!words[i] !== '' ? words[i] : '<br>') + '</div></li>' + (i + 1 < words.length ? '\n' : ''));
            }

            $("textarea").hide();
            $("ol.main").css("padding-left", 24 + 8 * words.length.toString().length + "px");
            $("ol.main").show();
          }

          $("#edit_button").val("Chỉnh sửa");
        }
      });

      $("#language_select").on("change", function () {
        if ($("#service_select").val() !== '') {
          $("#service_select").change();
        }
      });

      $("#service_select").on("change", function () {
        if ($("#edit_button").val() !== 'Xong') {
          let xhr = new XMLHttpRequest();

          if (orignalText == null || (service === '' && (!orignalText.includes(googleQueryText) || !orignalText.includes(microsoftQueryText)))) {
            orignalText = $("ol.main").html();
          }

          let words = orignalText.replace(/<li><div class="main">/g, '').replace(/<\/div><\/li>/g, '').split('\n');

          if ($("#service_select").val() === 'google') {
            if (service.includes('microsoft')) {
              microsoftTranslationText = $("ol.main").html();
            }

            if ($("#language_select").val() === googleLang && googleTranslationText != null && googleQueryText.includes(orignalText)) {
              $("ol.main").html(googleTranslationText);
            } else {
              googleTranslationText = '';

              for (let i = 0; i < words.length; i++) {
                xhr.onreadystatechange = function () {
                  if (this.readyState === this.DONE) {
                    googleTranslationText += '<li><div class="main">' + JSON.parse(this.responseText)[0][0][0].concat('</div></li>' + (i + 1 < words.length ? '\n' : ''));
                  }
                };

                translateGoogle(xhr, $("#language_select").val(), words[i]);
              }

              $("ol.main").html(googleTranslationText);
              googleLang = $("#language_select").val();
              googleQueryText = orignalText;
            }
          } else if ($("#service_select").val() === 'microsoft') {
            if (service.includes('google')) {
              googleTranslationText = $("ol.main").html();
            }

            if ($("#language_select").val() === microsoftLang && microsoftTranslationText != null && microsoftQueryText.includes(orignalText)) {
              $("ol.main").html(microsoftTranslationText);
            } else {
              let accessToken = getMicrosoftTranslatorAccessToken();

              if (accessToken != null) {
                microsoftTranslationText = '';

                for (let i = 0; i < words.length; i++) {
                  const data = JSON.stringify([
                    {
                      "Text": words[i]
                    }
                  ]);

                  xhr.onreadystatechange = function () {
                    if (this.readyState === this.DONE) {
                      microsoftTranslationText += '<li><div class="main">' + JSON.parse(this.responseText)[0].translations[0].text.concat('</div></li>' + (i + 1 < words.length ? '\n' : ''));
                    }
                  };
  
                  translateMicrosoft(xhr, accessToken, document.getElementById('language_select').value.replace('CN', 'CHS').replace('TW', 'CHT'), data);
                }

                $("ol.main").html(microsoftTranslationText);
                microsoftLang = $("#language_select").val();
                microsoftQueryText = orignalText;
              }
            }
          } else {
            if (service.includes('google')) {
              googleTranslationText = $("ol.main").html();
            } else if (service.includes('microsoft')) {
              microsoftTranslationText = $("ol.main").html();
            }

            $("ol.main").html(orignalText);
          }
        } else {
          if (service.includes('google')) {
            googleTranslationText = $("ol.main").html();
          } else if (service.includes('microsoft')) {
            microsoftTranslationText = $("ol.main").html();
          }

          $("#service_select").val("");
          $("ol.main").html(orignalText);
        }

        service = $("#service_select").val();
      });

      function translateMicrosoft(xhr, accessToken, toLang, data) {
        xhr.open("POST", "https://api.cognitive.microsofttranslator.com/translate?to=" + toLang + "&api-version=3.0&includeSentenceLength=true", false);
        xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(data);
      }

      function translateGoogle(xhr, targetLang, text) {
        xhr.open("GET", "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" + targetLang + "&dt=t&q=" + text, false);
        xhr.send();
      }

      function getMicrosoftTranslatorAccessToken() {
        let accessToken;
        let settings = {
          async: false,
          url: 'https://edge.microsoft.com/translate/auth',
          method: 'GET'
        };

        $.ajax(settings).done(response => accessToken = response);
        return accessToken;
      }
    </script>
  </body>
</html>