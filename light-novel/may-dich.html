<!DOCTYPE html>
<html lang="ja" class="hltr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, user-scalable=0, maximum-scale=1">
    <title>Máy dịch cho Light Novel - DoHoaiNam Pages</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="../js/js.cookie-1.5.1.js"></script>
    <link rel="stylesheet" href="../css/styles/dohoainam-ebpaj-style.css">
    <style>
      textarea {
        resize: none;
      }
    </style>
  </head>
  <body>
    <form>
      <div class="notranslate" style="bottom: 8px; left: 8px; position: fixed;">
        <select id="background_select">
          <option value="white">Trắng</option>
          <option value="black">Đen</option>
          <option value="sepia">Sepia</option>
          <option value="cream">Kem</option>
        </select>
      </div>
    </form>
    <form>
      <div class="notranslate" style="bottom: 8px; position: fixed; right: 8px;">
        <select id="language_select">
          <option value="vi">Việt</option>
          <option value="en">Anh</option>
          <option value="ja">Nhật</option>
          <option value="zh-CN">Trung (Giản thể)</option>
          <option value="zh-TW">Trung (Phổn thể)</option>
        </select>
        <select id="service_select">
          <option value="">Văn bản gốc</option>
          <option value="google">Google Dịch</option>
          <option value="microsoft">Trình dịch Microsoft</option>
        </select>
        <input id="edit_button" type="button" value="Xong">
      </div>
    </form>
    <section class="p-text">
      <ol class="main"></ol>
      <div style="text-align: center;"><textarea name="textarea" style="background: transparent; border: 0; border-style: none; color: inherit; font-family: inherit; font-size: inherit; height: 50vh; margin: 0; padding: 0; width: 100%;">Viết gì đó tại đây</textarea></div>
    </section>
    <script>
      var queryText;

      var service = $("#service_select").val();

      var googleLang;
      var googleQueryText;

      var microsoftLang;
      var microsoftQueryText;

      var googleTranslationText;
      var microsoftTranslationText;

      $("#background_select").on("change", function () {
        if (this.value !== 'white') {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != undefined ?
            document.documentElement.getAttribute('style').replace(/ black;/g, '').
              replace(/black;/g, '').
              replace(/ sepia;/g, '').
              replace(/sepia;/g, '').
              replace(/ cream;/g, '').
              replace(/cream;/g, '').
            concat(' ' + this.value.concat(';')) :
              this.value.concat(';'));
          Cookies.set('background', this.value, { expires: 365 });
        } else if ($(document.documentElement).attr("style") != undefined) {
          $(document.documentElement).attr("style", document.documentElement.getAttribute('style').replace(/ black;/g, '').
            replace(/black;/g, '').
            replace(/ sepia;/g, '').
            replace(/sepia;/g, '').
            replace(/ cream;/g, '').
            replace(/cream;/g, ''));
          Cookies.remove('background');
        } else {
          $(document.documentElement).removeAttr("style");
        }
      });

      $(document).ready(function () {
        $("#background_select").val($.cookie('background') || "white").change();
        $("ol.main").hide();
      });

      $("ol.main").on("input", function () {
        $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * document.querySelector('ol.main').innerHTML.split('\n').length.toString().concat('.').length + "px");

        if ($("ol.main").html() === '' || $("ol.main").html() === '<li><div class="main"></div></li>' || $("ol.main").html() === '<li><div class="main"><br></div></li>') {
          $("#service_select").val("");
          service = $("#service_select").val();
          $("ol.main").html(null);
          queryText = $("ol.main").html();
          $("div.main").removeAttr("style");
          $("ol.main").attr("contentEditable", "false");
          $("ol.main").hide();
          $("textarea").show();
        }
      });

      $("#edit_button").on("click", function () {
        if (this.value === 'Chỉnh sửa' && $("textarea").css("display") === 'none') {
          if ($("ol.main").html() === '') {
            $("ol.main").hide();
            $("textarea").show();
          } else {
            $("div.main").css("display", "inline-block");
            $("ol.main").attr("contentEditable", "true");
          }

          $("#edit_button").val("Xong");
        } else {
          if ($("textarea").css("display") === 'none') {
            $("div.main").removeAttr("style");
            $("ol.main").attr("contentEditable", "false");
          } else {
            var sentences = document.querySelector('textarea').value.split('\n');
            $("ol.main").html(null);

            for (let i = 0; i < sentences.length; i++) {
              $("ol.main").append('<li><div class="main">' + (sentences[i] !== '' ? sentences[i] : '<br>') + '</div></li>' + (i + 1 < sentences.length ? '\n' : ''));
            }

            $("textarea").hide();
            $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * document.querySelector('ol.main').innerHTML.split('\n').length.toString().concat('.').length + "px");
            $("ol.main").show();
          }

          $("#edit_button").val("Chỉnh sửa");
        }
      });

      $("#language_select").on("change", function () {
        if ($("#service_select").val() !== '') {
          $("#service_select").change();
        }
      });

      $("#service_select").change(function () {
        if ($("#edit_button").val() === 'Chỉnh sửa') {
          let xhr = new XMLHttpRequest();

          if (service === '' && (queryText == undefined || queryText === '' || queryText !== googleQueryText || queryText !== microsoftQueryText)) {
            queryText = $("ol.main").html();
          }

          let sentences = queryText.replace(/<li><div class="main">/g, '').replace(/<\/div><\/li>/g, '').split('\n');

          if (this.value === 'google') {
            if (service === 'microsoft') {
              microsoftTranslationText = $("ol.main").html();

              if (googleLang != null) {
                $("#language_select").val(googleLang);
              }
            }

            if ($("#language_select").val() === googleLang && googleTranslationText !== '' && googleQueryText === queryText) {
              $("ol.main").html(googleTranslationText);
            } else {
              googleTranslationText = '';

              for (let i = 0; i < sentences.length; i++) {
                xhr.onreadystatechange = function () {
                  if (this.readyState === this.DONE) {
                    googleTranslationText += '<li><div class="main">' + JSON.parse(this.responseText)[0][0][0] + '</div></li>' + (i + 1 < sentences.length ? '\n' : '');
                  } else if (this.readyState === this.UNSENT) {
                    googleTranslationText = '';
                    $("ol.main").html(queryText);
                    this.value = '';
                  }
                };

                if (sentences[i] !== '') {
                  translateGoogle(xhr, $("#language_select").val(), sentences[i]);
                } else {
                  googleTranslationText += '<li><div class="main"><br></div></li>' + (i + 1 < sentences.length ? '\n' : '');
                }
              }

              $("ol.main").html(googleTranslationText);
              googleLang = $("#language_select").val();
              googleQueryText = queryText;
            }
          } else if (this.value === 'microsoft') {
            if (service === 'google') {
              googleTranslationText = $("ol.main").html();

              if (microsoftLang != null) {
                $("#language_select").val(microsoftLang);
              }
            }

            if ($("#language_select").val() === microsoftLang && microsoftTranslationText !== '' && microsoftQueryText === queryText) {
              $("ol.main").html(microsoftTranslationText);
            } else {
              let accessToken = getMicrosoftTranslatorAccessToken();

              if (accessToken == undefined) {
                throw new Error('Cannot get a Access Token from the server.');
                this.value = '';
              }

              microsoftTranslationText = '';

              for (let i = 0; i < sentences.length; i++) {
                xhr.onreadystatechange = function () {
                  if (this.readyState === this.DONE) {
                    microsoftTranslationText += '<li><div class="main">' + JSON.parse(this.responseText)[0].translations[0].text + '</div></li>' + (i + 1 < sentences.length ? '\n' : '');
                  } else if (this.readyState === this.UNSENT) {
                    microsoftTranslationText = '';
                    $("ol.main").html(queryText);
                    this.value = '';
                  }
                };

                if (sentences[i] !== '') {
                  translateMicrosoft(xhr, accessToken, document.getElementById('language_select').value.replace('CN', 'CHS').replace('TW', 'CHT'), JSON.stringify([
                  {
                    "Text": sentences[i]
                  }
                ]));
                } else {
                  microsoftTranslationText += '<li><div class="main"><br></div></li>' + (i + 1 < sentences.length ? '\n' : '');
                }
              }

              $("ol.main").html(microsoftTranslationText);
              microsoftLang = $("#language_select").val();
              microsoftQueryText = queryText;
            }
          } else {
            if (service === 'google') {
              googleTranslationText = $("ol.main").html();
            } else if (service === 'microsoft') {
              microsoftTranslationText = $("ol.main").html();
            }

            $("ol.main").html(queryText);
          }
        } else {
          if (service === 'google') {
            googleTranslationText = $("ol.main").html();
          } else if (service === 'microsoft') {
            microsoftTranslationText = $("ol.main").html();
          }

          this.value = '';
        }

          service = this.value;
      });

      function translateGoogle(xhr, targetLang, queryText) {
        xhr.open("POST", "https://translate.googleapis.com/translate_a/single?anno=3&client=gtx&format=html&sl=auto&tl=" + targetLang + "&tc=1&dom=1&sr=1&mode=1&dt=t", false);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send("q=" + encodeURIComponent(queryText));
      }

      function translateMicrosoft(xhr, accessToken, toLang, data) {
        xhr.open("POST", "https://api.cognitive.microsofttranslator.com/translate?to=" + toLang + "&api-version=3.0&includeSentenceLength=true", false);
        xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(data);
      }

      function getMicrosoftTranslatorAccessToken() {
        let accessToken;
        $.ajax({
          async: false,
          url: 'https://edge.microsoft.com/translate/auth',
          method: 'GET'
        }).done(response => accessToken = response);
        return accessToken;
      }
    </script>
  </body>
</html>