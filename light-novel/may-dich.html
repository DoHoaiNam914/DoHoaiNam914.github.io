<!DOCTYPE html>
<html lang="ja" class="hltr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, user-scalable=0, maximum-scale=1">
    <title>Máy dịch cho Light Novel - DoHoaiNam Pages</title>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="../js/js.cookie-1.5.1.js"></script>
    <script src="../js/jquery.csv.js"></script>
    <link rel="stylesheet" href="../css/styles/dohoainam-ebpaj-style.css">
    <style>
      textarea {
        resize: none;
      }
    </style>
  </head>
  <body>
    <form>
      <div class="notranslate" style="bottom: 8px; left: 8px; position: fixed;">
        <select id="background_select">
          <option value="white">Trắng</option>
          <option value="black">Đen</option>
          <option value="sepia">Sepia</option>
          <option value="cream">Kem</option>
        </select>
      </div>
    </form>
    <form>
      <div class="notranslate" style="margin-bottom: 8px; text-align: initial; top: 8px;">
        <label for="glossary_file">Chọn tệp từ vựng CSV:</label>
        <input id="glossary_file" type="file" accept="text/csv">
      </div>
      <div class="notranslate" style="bottom: 8px; position: fixed; right: 8px;">
        <select id="language_select">
          <option value="vi">Việt</option>
          <option value="en">Anh</option>
          <option value="ja">Nhật</option>
          <option value="zh-CN">Trung (Giản thể)</option>
          <option value="zh-TW">Trung (Phổn thể)</option>
        </select>
        <select id="service_select">
          <option value="">Văn bản gốc</option>
          <option value="google">Google Dịch</option>
          <option value="microsoft">Trình dịch Microsoft</option>
          <option value="vietphrase">VietPhrase</option>
        </select>
        <input id="edit_button" type="button" value="Xong">
      </div>
    </form>
    <section class="p-text">
      <ol class="main"></ol>
      <div style="text-align: center;"><textarea name="textarea" style="background: transparent; border: 0; border-style: none; color: inherit; font-family: inherit; font-size: inherit; height: 50vh; margin: 0; padding: 0; width: 100%;">Viết gì đó tại đây</textarea></div>
    </section>
    <script>
      var queryText;
      var glossary;
      var customGlossary;

      var service = $("#service_select").val();

      var googleLang;
      var googleQueryText;

      var microsoftLang;
      var microsoftQueryText;

      var googleTranslationText;
      var microsoftTranslationText;

      var vietphraseLang;

      var Names;
      var NamesPhu;
      var VietPhrase;
      var ChinesePhienAmWords;
      var ChinesePhienAmEnglishWords;
      var Pronouns;

      var SourceVietPhrase;

      $(document).ready(function () {
        $("#background_select").val($.cookie('background') || "white").change();
        $.ajax({
          async: false,
          url: 'glossary.csv',
          method: 'GET'
        }).done((response) => glossary = $.csv.toArrays(response));
        $("ol.main").hide();
      });

      $("#background_select").on("change", function () {
        if (this.value !== 'white') {
          $(document.documentElement).attr("style", $(document.documentElement).attr("style") != undefined ?
            document.documentElement.getAttribute('style').replace(/ black;/g, '')
              .replace(/black;/g, '')
              .replace(/ sepia;/g, '')
              .replace(/sepia;/g, '')
              .replace(/ cream;/g, '')
              .replace(/cream;/g, '')
              .concat(' ' + this.value.concat(';')) :
            this.value.concat(';'));
          Cookies.set('background', this.value, { expires: 365 });
        } else if ($(document.documentElement).attr("style") != undefined) {
          $(document.documentElement).attr("style", document.documentElement.getAttribute('style').replace(/ black;/g, '')
            .replace(/black;/g, '')
            .replace(/ sepia;/g, '')
            .replace(/sepia;/g, '')
            .replace(/ cream;/g, '')
            .replace(/cream;/g, ''));
          Cookies.remove('background');
        } else {
          $(document.documentElement).removeAttr("style");
        }
      });

      $("#glossary_file").on("input", function () {
        let reader = new FileReader();
        reader.readAsText(this.files[0]);
        reader.onload = function () {
          customGlossary = $.csv.toArrays(this.result);
        };
      });

      $("#language_select").on("change", function () {
        if ($("#service_select").val() !== '') {
          $("#service_select").change();
        }
      });

      $("#service_select").change(function () {
        if ($("#edit_button").val() === 'Chỉnh sửa') {
          if (this.value === 'vietphrase' && service !== this.value) {
            $("#language_select").html(`<option value="vietphrase">VietPhrase<\/option>
<option value="han-viet">Hán Việt<\/option>`);
          } else if (this.value !== 'vietphrase' && service === 'vietphrase') {
            $("#language_select").html(`<option value="vi">Việt<\/option>
<option value="en">Anh<\/option>
<option value="ja">Nhật<\/option>
<option value="zh-CN">Trung (Giản thể)<\/option>
<option value="zh-TW">Trung (Phổn thể)<\/option>`);
          }

          let xhr = new XMLHttpRequest();

          if (service === '' && (queryText == undefined || queryText === '' || getGlossaryText(queryText) !== googleQueryText || getGlossaryText(queryText) !== microsoftQueryText)) {
            queryText = $("ol.main").html();
          }

          let sentences = queryText.replace(/<li><div class="main">/g, '').replace(/<\/div><\/li>/g, '').split('\n');
          var counter = sentences.length;
          var sessionTranslate = [];

          if (this.value === 'google') {
            if (service === 'microsoft') {
              microsoftTranslationText = $("ol.main").html();

              if (googleLang != null) {
                $("#language_select").val(googleLang);
              }
            }

            if ($("#language_select").val() === googleLang && googleTranslationText !== '' && googleQueryText === getGlossaryText(queryText)) {
              $("ol.main").html(googleTranslationText);
            } else {
              googleTranslationText = '';
              var session = '';

              for (let i = 0; i < sentences.length; i++) {
                sessionTranslate.push(getGlossaryText(sentences[i]));

                if ((counter >= 50 && sessionTranslate.length === 50) || (counter < 50 && sessionTranslate.length === counter)) {
                  for (let j = 0; j < sessionTranslate.length; j++) {
                    session += "q=" + encodeURIComponent(sessionTranslate[j]) + (j + 1 < sessionTranslate.length ? '&' : '');
                  }

                  xhr.onreadystatechange = function () {
                    if (this.readyState === this.DONE) {
                      for (let j = 0; j < sessionTranslate.length; j++) {
                        if (sessionTranslate[j] !== '<br>') {
                          googleTranslationText += '<li><div class="main">' + JSON.parse(this.responseText)[0][j] + '</div></li>' + (i + 1 < sentences.length && counter === 0 ? '\n' : '');
                        } else {
                          googleTranslationText += '<li><div class="main"><br></div></li>' + (i + 1 < sentences.length && counter === 0 ? '\n' : '');
                        }

                        counter -= 1;
                      }
                    } else if (this.readyState === this.UNSENT) {
                      googleTranslationText = '';
                      $("ol.main").html(queryText);
                      this.value = '';
                    }
                  };

                  translateGoogle(xhr, $("#language_select").val(), session);
                  session = '';
                  sessionTranslate = [];
                }
              }

              $("ol.main").html(googleTranslationText);
              googleLang = $("#language_select").val();
              googleQueryText = getGlossaryText(queryText);
            }
          } else if (this.value === 'microsoft') {
            if (service === 'google') {
              googleTranslationText = $("ol.main").html();

              if (microsoftLang != null) {
                $("#language_select").val(microsoftLang);
              }
            }

            if ($("#language_select").val() === microsoftLang && microsoftTranslationText !== '' && microsoftQueryText === getGlossaryText(queryText)) {
              $("ol.main").html(microsoftTranslationText);
            } else {
              let accessToken = getMicrosoftTranslatorAccessToken();

              if (accessToken == undefined) {
                throw new Error('Cannot get a Access Token from the server.');
                this.value = '';
              }

              microsoftTranslationText = '';
              var session = [];

              for (let i = 0; i < sentences.length; i++) {
                sessionTranslate.push(getGlossaryText(sentences[i]));

                if ((counter >= 50 && sessionTranslate.length === 50) || (counter < 50 && sessionTranslate.length === counter)) {
                  for (let j = 0; j < sessionTranslate.length; j++) {
                    session.push({
                      "Text":sessionTranslate[j]
                    });
                  }

                  xhr.onreadystatechange = function () {
                    if (this.readyState === this.DONE) {
                      for (let j = 0; j < sessionTranslate.length; j++) {
                        if (sessionTranslate[j] !== '<br>') {
                          microsoftTranslationText += '<li><div class="main">' + JSON.parse(this.responseText)[j].translations[0].text + '</div></li>' + (i + 1 < sentences.length && counter === 0 ? '\n' : '');
                        } else {
                          microsoftTranslationText += '<li><div class="main"><br></div></li>' + (i + 1 < sentences.length && counter === 0 ? '\n' : '');
                        }

                        counter -= 1;
                      }
                    } else if (this.readyState === this.UNSENT) {
                      microsoftTranslationText = '';
                      $("ol.main").html(queryText);
                      this.value = '';
                    }
                  };

                  translateMicrosoft(xhr, accessToken, document.getElementById('language_select').value.replace('CN', 'CHS').replace('TW', 'CHT'), JSON.stringify(session));
                  session = [];
                  sessionTranslate = [];
                }
              }

              $("ol.main").html(microsoftTranslationText);
              microsoftLang = $("#language_select").val();
              microsoftQueryText = getGlossaryText(queryText);
            }
          } else if (this.value === 'vietphrase') {
            if (service === 'google') {
              googleTranslationText = $("ol.main").html();

              if (vietphraseLang != null) {
                $("#language_select").val(vietphraseLang);
              }
            } else if (service === 'microsoft') {
              microsoftTranslationText = $("ol.main").html();

              if (vietphraseLang != null) {
                $("#language_select").val(vietphraseLang);
              }
            }

            loadVietphrase();
            $("ol.main").html(null);

            for (let i = 0; i < sentences.length; i++) {
              var convertText = sentences[i];

              if (sentences[i] !== '<br>') {
                for (let j = 0; glossary != undefined && j < glossary.length; j++) {
                  convertText = convertText.replace(new RegExp(glossary[j][0], 'g'), glossary[j][1].concat(' '));
                }

                for (let j = 0; $("#language_select").val() === 'vietphrase' && customGlossary != undefined && j < customGlossary.length; j++) {
                  convertText = convertText.replace(new RegExp(customGlossary[j][0], 'g'), customGlossary[j][1].concat(' '));
                }

                for (let j = 0; $("#language_select").val() === 'vietphrase' && Names != undefined && j < Names.length; j++) {
                  convertText = convertText.replace(new RegExp(Names[j][0], 'g'), Names[j][1].concat(' '));
                }

                for (let j = 0; $("#language_select").val() === 'vietphrase' && NamesPhu != undefined && j < NamesPhu.length; j++) {
                  convertText = convertText.replace(new RegExp(NamesPhu[j][0], 'g'), NamesPhu[j][1].concat(' '));
                }

                for (let j = 0; $("#language_select").val() === 'vietphrase' && VietPhrase != undefined && j < VietPhrase.length; j++) {
                  SourceVietPhrase = VietPhrase[j];
                  convertText = convertText.replace(new RegExp(SourceVietPhrase[0], 'g'), SourceVietPhrase[1].concat(' '));
                }

                for (let j = 0; $("#language_select").val() === 'han-viet' && ChinesePhienAmWords != undefined && j < ChinesePhienAmWords.length; j++) {
                  convertText = convertText.replace(new RegExp(ChinesePhienAmWords[j][0], 'g'), ChinesePhienAmWords[j][1].concat(' '));
                }

                for (let j = 0; $("#language_select").val() === 'han-viet' && ChinesePhienAmEnglishWords != undefined && j < ChinesePhienAmEnglishWords.length; j++) {
                  convertText = convertText.replace(new RegExp(ChinesePhienAmEnglishWords[j][0], 'g'), ChinesePhienAmEnglishWords[j][1].concat(' '));
                }

                for (let j = 0; $("#language_select").val() === 'vietphrase' && Pronouns != undefined && j < Pronouns.length; j++) {
                  convertText = convertText.replace(new RegExp(Pronouns[j][0], 'g'), Pronouns[j][1].concat(' '));
                }

                let replace = new Map([
                  [' 。', '. '],
                  [' ，', ', '],
                  [' 、', ', '],
                  [' ？', '? '],
                  [' ！', '! '],
                  [' ．', '. '],
                  [' ・', ' '],
                  [' 　', ' ']
                ]);

                replace.forEach((value, key) => convertText = convertText.trim().replace(new RegExp(key, 'g'), value));
                convertText = convertText.replace(/(^|[.?!:“’(\[⟨] *)([a-z])/g, function (match, separator, char) { return separator + char.toUpperCase(); });
                $("ol.main").append("<li><div class=\"main\">" + convertText.trim() + "</div></li>" + (i + 1 < sentences.length ? "\n" : ""));
              } else {
                $("ol.main").append("<li><div class=\"main\"><br></div></li>" + (i + 1 < sentences.length ? "\n" : ""));
              }
            }

            vietphraseLang = $("#language_select").val();
          } else {
            if (service === 'google') {
              googleTranslationText = $("ol.main").html();
            } else if (service === 'microsoft') {
              microsoftTranslationText = $("ol.main").html();
            }

            $("ol.main").html(queryText);
          }
        }

        service = this.value;
      });

      $("#edit_button").on("click", function () {
        if (this.value === 'Chỉnh sửa' && $("textarea").css("display") === 'none') {
          if ($("ol.main").html() === '') {
            $("ol.main").hide();
            $("textarea").show();
          } else {
            $("div.main").css("display", "inline-block");
            $("ol.main").attr("contentEditable", true);
            $("#service_select").prop("disabled", true);
          }

          this.value = 'Xong';
        } else {
          if ($("textarea").css("display") === 'none') {
            $("div.main").removeAttr("style");
            $("ol.main").removeAttr("contentEditable");
            $("#service_select").prop("disabled", false);
          } else {
            var sentences = document.querySelector('textarea').value.split('\n');
            $("ol.main").html(null);

            for (let i = 0; i < sentences.length; i++) {
              $("ol.main").append('<li><div class="main">' + (sentences[i] !== '' ? sentences[i] : '<br>') + '</div></li>' + (i + 1 < sentences.length ? '\n' : ''));
            }

            $("textarea").hide();
            $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * document.querySelector('ol.main').innerHTML.split('\n').length.toString().concat('.').length + "px");
            $("ol.main").show();
          }

          this.value = 'Chỉnh sửa';
        }
      });

      $("ol.main").on("input", function () {
        $("ol.main").css("padding-left", parseInt($(document.documentElement).css("font-size")) + 8 * $("ol.main").html().split('\n').length.toString().concat('.').length + "px");

        if ($("ol.main").html() === '' || $("ol.main").html() === '<li><div class="main"></div></li>' || $("ol.main").html() === '<li><div class="main"><br></div></li>') {
          $("#service_select").val("");
          $("#language_select").html(`<option value="vi">Việt<\/option>
<option value="en">Anh<\/option>
<option value="ja">Nhật<\/option>
<option value="zh-CN">Trung (Giản thể)<\/option>
<option value="zh-TW">Trung (Phổn thể)<\/option>`);
          service = $("#service_select").val();
          $("ol.main").html(null);
          queryText = $("ol.main").html();
          $("div.main").removeAttr("style");
          $("ol.main").attr("contentEditable", false);
          $("#service_select").prop("disabled", false);
          $("ol.main").hide();
          $("textarea").show();
        }
      });

      function getGlossaryText(text) {
        var glossaryText;

        for (let i = 0; glossary != undefined && i < glossary.length; i++) {
          glossaryText = text.replace(new RegExp(glossary[i][0], 'g'), glossary[i][1]);
        }

        for (let i = 0; customGlossary != undefined && i < customGlossary.length; i++) {
          glossaryText = glossaryText.replace(new RegExp(customGlossary[i][0], 'g'), customGlossary[i][1]);
        }

        return glossaryText;
      }

      function translateGoogle(xhr, targetLang, query) {
        xhr.open("POST", "https://translate.googleapis.com/translate_a/t?anno=3&client=gtx&format=json&v=1.0&key&sl=auto&tl=" + targetLang + "&sr=1&mode=1", false);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send(query);
      }

      function translateMicrosoft(xhr, accessToken, toLang, data) {
        xhr.open("POST", "https://api.cognitive.microsofttranslator.com/translate?to=" + toLang + "&api-version=3.0&includeSentenceLength=true", false);
        xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(data);
      }

      function getMicrosoftTranslatorAccessToken() {
        let accessToken;
        $.ajax({
          async: false,
          url: 'https://edge.microsoft.com/translate/auth',
          method: 'GET'
        }).done(response => accessToken = response);
        return accessToken;
      }

      function loadVietphrase() {
        if (Names === undefined) {
          $.ajax({
            async: false,
            url: '../vietphrase/Names.csv',
            method: 'GET'
          }).done((response) => Names = $.csv.toArrays(response));
        }

        if (NamesPhu === undefined) {
          $.ajax({
            async: false,
            url: '../vietphrase/Names2.csv',
            method: 'GET'
          }).done((response) => NamesPhu = $.csv.toArrays(response));
        }

        if (VietPhrase === undefined) {
          $.ajax({
            async: false,
            url: '../vietphrase/VietPhrase.csv',
            method: 'GET'
          }).done((response) => VietPhrase = $.csv.toArrays(response));
        }

        if (ChinesePhienAmWords === undefined) {
          $.ajax({
            async: false,
            url: '../vietphrase/ChinesePhienAmWords.csv',
            method: 'GET'
          }).done((response) => ChinesePhienAmWords = $.csv.toArrays(response));
        }

        if (ChinesePhienAmEnglishWords === undefined) {
          $.ajax({
            async: false,
            url: '../vietphrase/ChinesePhienAmEnglishWords.csv',
            method: 'GET'
          }).done((response) => ChinesePhienAmEnglishWords = $.csv.toArrays(response));
        }

        if (Pronouns === undefined) {
          $.ajax({
            async: false,
            url: '../vietphrase/Pronouns.csv',
            method: 'GET'
          }).done((response) => Pronouns = $.csv.toArrays(response));
        }
      }
    </script>
  </body>
</html>